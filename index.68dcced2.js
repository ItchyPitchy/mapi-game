function t(t){return t&&t.__esModule?t.default:t}var e,s,i,o,n,a={};a=new URL("stockholm_map.2976de6e.png",import.meta.url).toString();const r=(t,e)=>{let s=Math.ceil(t);return Math.floor(Math.random()*(Math.floor(e)-s+1)+s)};s=class{position;size;rotation;constructor(t,e,s=0){this.position=t,this.size=e,this.rotation=s}distanceTo(t){return Math.sqrt(Math.pow(this.position.x-t.x,2)+Math.pow(this.position.y-t.y,2))}draw(t,e){throw Error("#draw not implemented yet!")}};const h={archeologist:{type:"archeologist",skills:[{name:"Hit",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=0,fixedBonus:e=0})=>({type:"damage",points:10*t+e}),unlockLvl:1},{name:"Throw Dirt",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"blind",duration:2}),unlockLvl:1},{name:"Examine",validTarget:["enemy"],numberOfTargets:-1,generateSkillEffect:()=>({type:"weaken",duration:1}),unlockLvl:2},{name:"Dig",validTarget:["allies"],numberOfTargets:1,generateSkillEffect:()=>({type:"evade",duration:2}),unlockLvl:3}]},medic:{type:"medic",skills:[{name:"Stitch",validTarget:["allies","self"],numberOfTargets:1,generateSkillEffect:()=>({type:"heal",points:15}),unlockLvl:1},{name:"Cut",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=0,fixedBonus:e=0})=>({type:"damage",points:15*t+e}),unlockLvl:1},{name:"Drain Blood",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"bleed",points:10,duration:3}),unlockLvl:2},{name:"Restrain",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"snare",duration:1}),unlockLvl:3},{name:"Drug",validTarget:["enemy"],numberOfTargets:2,generateSkillEffect:()=>({type:"confuse",duration:1}),unlockLvl:4}]},zombie:{type:"zombie",skills:[{name:"Scratch",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=0,fixedBonus:e=0})=>({type:"damage",points:15*t+e}),unlockLvl:1}]}};var l={};l=new URL("zombie_spritesheet.cc0599cc.png",import.meta.url).toString();class c extends s{lvl;size={height:100,width:100};name="Zombie";role=h.zombie;hp;stats;effects=[];spritesheet=new Image;constructor(e,s,i=0,o={height:50,width:50}){super(s,o,i),this.lvl=e,this.spritesheet.src=t(l);let n=this.generateStatsFromLvl(e);this.hp=n.maxHp,this.stats=n}generateStatsFromLvl(t){return{maxHp:40*t,maxStamina:40*t,strength:1*t,intelligence:1*t,hitRate:1-.4*t,dodgeChance:1-.9*t}}draw({ctx:t,offsetX:e=0,offsetY:s=0},i=!1){if(t.save(),t.translate(e,s),t.imageSmoothingEnabled=!1,i){t.shadowColor="yellow",t.shadowBlur=0;let e=[-2,2];for(let s=0;s<e.length;s++){t.shadowOffsetX=e[s];for(let s=0;s<e.length;s++)t.shadowOffsetY=e[s],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore()}}var p={};p=new URL("mami_spritesheet.b49e3f9a.png",import.meta.url).toString();class d extends s{lvl;stats;name="Mami";role=h.medic;hp;effects=[];spritesheet=new Image;constructor(e,s,i,o=0,n={height:96,width:96}){super(i,n,o),this.lvl=e,this.stats=s,this.spritesheet.src=t(p),this.hp=s.maxHp}draw({ctx:t,offsetX:e=0,offsetY:s=0},i=!1){if(t.save(),t.translate(e,s),t.imageSmoothingEnabled=!1,i){t.shadowColor="yellow",t.shadowBlur=0;let e=[-2,2];for(let s=0;s<e.length;s++){t.shadowOffsetX=e[s];for(let s=0;s<e.length;s++)t.shadowOffsetY=e[s],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore()}}var m={};m=new URL("papi_spritesheet.5fe8d860.png",import.meta.url).toString();class u extends s{lvl;stats;name="Papi";role=h.archeologist;hp;effects=[];spritesheet=new Image;constructor(e,s,i,o=0,n={height:96,width:96}){super(i,n,o),this.lvl=e,this.stats=s,this.spritesheet.src=t(m),this.hp=s.maxHp}draw({ctx:t,offsetX:e=0,offsetY:s=0},i=!1){if(t.save(),t.translate(e,s),t.imageSmoothingEnabled=!1,i){t.shadowColor="yellow",t.shadowBlur=0;let e=[-2,2];for(let s=0;s<e.length;s++){t.shadowOffsetX=e[s];for(let s=0;s<e.length;s++)t.shadowOffsetY=e[s],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore()}}class g{background;foes;players;constructor(t,e,s){this.background=s,this.foes=this.generateFoes(t,e.foes),this.players=this.generatePlayers(t,e.players)}generateFoes(t,e){let s=r(e.min,e.max),i=[];for(let t=0;t<s;t++){let t=Math.floor(Math.random()*e.types.length),s=e.types[t];if(!s)continue;let o=r(s.lvl.min,s.lvl.max);i.push({type:s.type,lvl:o})}let o=t.gameHeight/3,n=i.length%3==0?3:i.length%3;return i.map((t,e)=>{let s=Math.floor(e/3)+1,a=Math.ceil(i.length/3)===s?n:3,r=o/a;switch(t.type){case"zombie":case"brute":return new c(t.lvl,{x:40+70*s-e%3*(60/a),y:e%3*r+r/2+2*o})}})}generatePlayers(t,e){let s=t.gameHeight/3,i=e.length%3==0?3:e.length%3;return e.map((o,n)=>{let a=Math.floor(n/3)+1,r=Math.ceil(e.length/3)===a?i:3,h=s/r,l=n%3*h+h/2+2*s,c=t.gameWidth-70*a-n%3*(60/r);switch(o.name){case"mami":return new d(o.lvl,o.stats,{x:c,y:l});case"papi":return new u(o.lvl,o.stats,{x:c,y:l})}})}drawBackground({game:t,ctx:e,offsetX:s=0,offsetY:i=0}){let o=Math.min(t.gameWidth/this.background.width,t.gameHeight/this.background.height),n=(t.gameWidth-this.background.width*o)/2,a=(t.gameHeight-this.background.height*o)/2;e.translate(s,i),e.drawImage(this.background,0,0,this.background.width,this.background.height,n,a,this.background.width*o,this.background.height*o),e.resetTransform()}}var w={};w=new URL("ahlens_map.e96a496f.png",import.meta.url).toString();class f extends g{constructor(e,s){let i=new Image;i.src=t(w),super(e,{players:s,foes:{min:3,max:4,types:[{type:"zombie",lvl:{min:1,max:2}},{type:"brute",lvl:{min:1,max:2}}]}},i)}}(e=i||(i={}))[e.BATTLE=0]="BATTLE";class y{texture;stops=[{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:577,y:206},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:548,y:252},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:467,y:310},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:493,y:376},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:335,y:384},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:362,y:460},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:430,y:452}];currentStop=this.stops[0];player={originPos:{x:this.stops[0].x,y:this.stops[0].y},queue:[]};constructor(){let e=new Image;e.src=t(a),this.texture=e}}var x={};x=new URL("player.8afcec90.png",import.meta.url).toString(),o=class{constructor(){}};class S extends o{x;y;constructor(t,e){super(),this.x=t,this.y=e}magnitude(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}dot(t){return this.x*t.x+this.y*t.y}norm(){return{x:this.x/this.magnitude(),y:this.y/this.magnitude()}}normalize(){let t=this.norm();return new S(t.x,t.y)}}const b=["up","left","down","right","esc","enter"];class v{game;map=new y;playerTexture;constructor(e){this.game=e;let s=new Image;s.src=t(x),this.playerTexture=s}update(t){if(b.some(t=>this.game.input.has(t))&&this.game.input.forEach(t=>{let e=this.map.stops.indexOf(this.map.currentStop),s=this.map.stops.length-1===e?null:{stop:this.map.stops[e+1],vectorTo:new S(this.map.stops[e+1].x-this.map.currentStop.x,this.map.stops[e+1].y-this.map.currentStop.y)},i=0===e?null:{stop:this.map.stops[e-1],vectorTo:new S(this.map.stops[e-1].x-this.map.currentStop.x,this.map.stops[e-1].y-this.map.currentStop.y)};switch(t){case"up":(s&&s.vectorTo.y<0||i&&i.vectorTo.y<0)&&(s&&i?s.vectorTo.norm().y<i.vectorTo.norm().y?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"down":(s&&s.vectorTo.y>0||i&&i.vectorTo.y>0)&&(s&&i?s.vectorTo.norm().y>i.vectorTo.norm().y?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"left":(s&&s.vectorTo.x<0||i&&i.vectorTo.x<0)&&(s&&i?s.vectorTo.norm().x<i.vectorTo.norm().x?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"right":(s&&s.vectorTo.x>0||i&&i.vectorTo.x>0)&&(s&&i?s.vectorTo.norm().x>i.vectorTo.norm().x?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"esc":this.game.state="PAUSE_SCREEN",this.game.pauseScreen.show();break;case"enter":{let t=this.map.currentStop.setupBattle({game:this.game,players:this.game.players});this.game.battleSystem.battle.active=t,this.game.state="BATTLE_SCENE"}}let o=this.map.player.queue.indexOf(this.map.currentStop);o>=0?this.map.player.queue=this.map.player.queue.slice(0,o+1):(this.map.currentStop.x!==this.map.player.originPos.x||this.map.currentStop.y!==this.map.player.originPos.y)&&this.map.player.queue.push(this.map.currentStop)}),0!==this.map.player.queue.length){let e=new S(this.map.player.queue[0].x-this.map.player.originPos.x,this.map.player.queue[0].y-this.map.player.originPos.y),s=e.norm(),i=new S(170*s.x*t,170*s.y*t);i.magnitude()>e.magnitude()?(this.map.player.originPos.x=this.map.player.queue[0].x,this.map.player.originPos.y=this.map.player.queue[0].y,this.map.player.queue.shift()):(this.map.player.originPos.x+=i.x,this.map.player.originPos.y+=i.y)}}draw(t){let e=Math.min(this.game.gameWidth/this.map.texture.width,this.game.gameHeight/this.map.texture.height),s=(this.game.gameWidth-this.map.texture.width*e)/2,i=(this.game.gameHeight-this.map.texture.height*e)/2;t.clearRect(0,0,this.game.gameWidth,this.game.gameHeight),t.drawImage(this.map.texture,0,0,this.map.texture.width,this.map.texture.height,s,i,this.map.texture.width*e,this.map.texture.height*e);for(let e=0;e<this.map.stops.length;e++)this.map.stops[e+1]&&(t.save(),t.beginPath(),t.setLineDash([5,3]),t.moveTo(this.map.stops[e].x+s,this.map.stops[e].y+i),t.lineTo(this.map.stops[e+1].x+s,this.map.stops[e+1].y+i),t.lineWidth=3,t.stroke(),t.restore()),t.save(),t.fillStyle=this.map.currentStop===this.map.stops[e]?"red":"orange",t.beginPath(),t.arc(this.map.stops[e].x+s,this.map.stops[e].y+i,5,0,2*Math.PI),t.fill(),t.restore();t.drawImage(this.playerTexture,this.map.player.originPos.x+s-17.5,this.map.player.originPos.y+i-40,35,35)}}const M=t=>{let e=document.getElementById(t);if(null===e)throw Error(`Could not find element with id ${t}`);return e},k=M("pauseScreen"),T=M("options"),_=["up","left","down","right","enter","esc"];class E{game;options=[{id:"continue",text:"Continue"},{id:"map",text:"Map"},{id:"settings",text:"Settings"},{id:"credits",text:"Credits"}];selectedOption="continue";constructor(t){this.game=t;let e=M("options");for(let t of this.options){let s=document.createElement("span");t.id===this.selectedOption&&s.setAttribute("data-selected","selected"),s.setAttribute("data-optionId",t.id),s.textContent=t.text,s.addEventListener("mouseenter",()=>{this.handleSwitchSelectedOption(()=>t)}),s.addEventListener("click",()=>{this.handleSubmitOption()}),e.appendChild(s)}}show(){k.style.display="flex"}hide(){k.style.display="none"}handleSwitchSelectedOption(t){let e=T.querySelector("[data-selected='selected']");if(e){e.removeAttribute("data-selected");let s=e.getAttribute("data-optionId"),i=this.options.findIndex(t=>t.id===s),o=t(-1===i?null:i),n=T.querySelector(`[data-optionId='${o.id}']`);n&&(this.selectedOption=o.id,n.setAttribute("data-selected","selected"))}}handleSubmitOption(){switch(this.selectedOption){case"continue":this.hide(),this.game.state="RUNNING";break;case"map":this.hide(),this.game.state="MAP_SCREEN"}}update(){_.some(t=>this.game.input.has(t))&&this.game.input.forEach(t=>{switch(t){case"up":this.handleSwitchSelectedOption(t=>0===t||null===t?this.options[this.options.length-1]:this.options[t-1]);break;case"down":this.handleSwitchSelectedOption(t=>t===this.options.length-1||null===t?this.options[0]:this.options[t+1]);break;case"esc":this.hide(),this.game.state="RUNNING";break;case"enter":this.handleSubmitOption()}})}}const C=["up","left","down","right","esc","enter"];class A{game;battle={active:null,queue:[]};state={name:"SLEEP"};animations=[{type:"commence-battle",durationMs:1200,timePassedMs:0}];constructor(t){this.game=t}update(t){if(this.battle.active&&(this.updateAnimations(t).deleted.some(t=>"commence-battle"===t.type)&&(this.state=this.calculateNextState(this.battle.active)),C.some(t=>this.game.input.has(t))))for(let t of this.game.input)switch(this.state.name){case"SLEEP":case"ENEMY_TURN":break;case"PLAYER_SELECT_SKILL":switch(t){case"up":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=s.indexOf(e),o=s.at(i-1);o&&(this.state.focusedSkill=o);break}case"down":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=s.indexOf(e),o=s.at(i-2+1);o&&(this.state.focusedSkill=o);break}case"left":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=t.findIndex(t=>t.some(t=>t===e)),o=s.indexOf(e),n=t.at(i-1)?.at(o);n&&(this.state.focusedSkill=n);break}case"right":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=t.findIndex(t=>t.some(t=>t===e)),o=s.indexOf(e),n=t.at(i-t.length)?.at(o);n&&(this.state.focusedSkill=n);break}case"esc":this.game.state="PAUSE_SCREEN",this.game.pauseScreen.show();break;case"enter":this.state={name:"PLAYER_SELECT_TARGET",characterTurn:this.state.characterTurn,selectedSkill:this.state.focusedSkill,selectedTargets:[],focusedTarget:this.battle.active.foes[0]}}break;case"PLAYER_SELECT_TARGET":{let e=[...this.battle.active.players,...this.battle.active.foes],s=e.indexOf(this.state.focusedTarget),[i]=e.splice(s,1);if(!i)throw Error("#currentlySelectedTarget is undefined!");let o=e.map(t=>({target:t,vectorTo:new S(t.position.x-i.position.x,t.position.y-i.position.y)}));switch(t){case"up":{let t=o.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.y)>Math.abs(e.x)}).filter(t=>t.vectorTo.y<0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"down":{let t=o.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.y)>Math.abs(e.x)}).filter(t=>t.vectorTo.y>0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"left":{let t=o.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.x)>Math.abs(e.y)}).filter(t=>t.vectorTo.x<0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"right":{let t=o.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.x)>Math.abs(e.y)}).filter(t=>t.vectorTo.x>0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"enter":this.state.selectedTargets.push(this.state.focusedTarget),this.state.selectedTargets.length>=2&&this.executeAction(this.state);break;case"esc":this.game.state="PAUSE_SCREEN",this.game.pauseScreen.show()}}}}updateAnimations(t){this.animations=this.animations.map(e=>({...e,timePassedMs:e.timePassedMs+1e3*t}));let e=this.animations.reduce((t,e)=>e.timePassedMs>=e.durationMs?{...t,finished:[...t.finished,e]}:{...t,inProgress:[...t.inProgress,e]},{inProgress:[],finished:[]});return this.animations=e.inProgress,{deleted:e.finished}}calculateNextState(t){let e=t.players[0],s=e.role.skills;return{name:"PLAYER_SELECT_SKILL",characterTurn:e,focusedSkill:s[0]}}mapToSkillSet(t){let e=Array(t.length%2==0?t.length:t.length+t.length%2).fill(null);for(let s=0;s<e.length;s++)t[s]&&(e[s]=t[s]);let s=e.length/2,i=[];for(let t=0;t<s;t++)i.push(e.slice(2*t,2));return i}executeAction(t){t.selectedTargets.forEach(e=>{e.effects.push(t.selectedSkill.generateSkillEffect({}))})}draw(t){if(this.battle.active){if(t.clearRect(0,0,this.game.gameWidth,this.game.gameHeight),!this.animations.some(t=>"commence-battle"===t.type))for(let e of(t.imageSmoothingEnabled=!1,this.battle.active.drawBackground({ctx:t,game:this.game}),[...this.battle.active.foes,...this.battle.active.players])){let s="PLAYER_SELECT_TARGET"===this.state.name&&this.state.focusedTarget===e;e.draw({ctx:t},s)}for(let e of this.animations){let s=Math.min(e.timePassedMs/e.durationMs,1);if("commence-battle"===e.type){let e=this.game.gameWidth*s-this.game.gameWidth;t.imageSmoothingEnabled=!1,this.battle.active.drawBackground({ctx:t,game:this.game,offsetX:-e,offsetY:0});let i=this.game.gameWidth-this.game.gameWidth*s;for(let e of[...this.battle.active.foes,...this.battle.active.players])e.draw({ctx:t,offsetX:-i,offsetY:0})}}if("PLAYER_SELECT_SKILL"===this.state.name){let e=this.mapToSkillSet(this.state.characterTurn.role.skills);for(let s=0;s<e.length;s++)for(let i=0;i<2;i++){let o=this.game.gameWidth/e.length;t.save(),t.fillStyle="lightgray",t.lineWidth=5,t.strokeStyle="black",t.fillRect(o*s,50*i,o,50),t.strokeRect(o*s+2.5,50*i+2.5,o-5,45),t.restore();let n=e[s][i];n&&(t.save(),t.font="30px serif",t.textAlign="center",t.fillStyle="black",t.fillText(n.name,o*s+o/2,50*i+40),t.restore())}for(let s=0;s<e.length;s++)for(let i=0;i<2;i++){let o=this.game.gameWidth/e.length;t.save(),t.lineWidth=5,t.strokeStyle="red",e[s][i]===this.state.focusedSkill&&t.strokeRect(o*s+2.5,50*i+2.5,o-5,45),t.restore()}}}}}class R{position;size;vector;components;constructor(t,e,s=new S(0,0),i=[]){this.position=t,this.size=e,this.vector=s,this.components=i}distanceTo(t){return Math.sqrt(Math.pow(this.position.x-t.position.x,2)+Math.pow(this.position.y-t.position.y,2))}getComponent(t){for(let e of this.components)if(e instanceof t)return e;throw Error(`Failed to get component type ${t}. Please run hasComponent first!`)}addComponents(...t){for(let e of t)this.components.push(e)}hasComponent(t){for(let e of this.components)if(e instanceof t)return!0;return!1}removeComponent(t){this.components=this.components.filter(e=>e!==t)}calculateHitbox(){throw Error("#calculateHitbox not implemented yet")}draw(t,e){throw Error("#draw not implemented yet")}}var H={};H=new URL("blood_splatter_v1-Sheet.5ea6ebae.png",import.meta.url).toString();const L=new Image;L.src=t(H);const z={sprites:12,img:L,width:46,height:35};class I extends R{direction;durationMs;progressMs=0;constructor(t,e,s,i={height:2.1*z.height,width:2.1*z.width}){super(t,i,new S(0,0)),this.direction=e,this.durationMs=s}calculateHitbox(){let t=this.position.x;return{x:t,y:this.position.y,width:this.size.width,height:this.size.height}}draw(t,e){t.save(),t.imageSmoothingEnabled=!1;let s=1;"left"===this.direction&&(s=-1),"right"===this.direction&&(s=1),t.scale(s,1);let i=Math.floor((this.progressMs>this.durationMs?this.progressMs%this.durationMs/this.durationMs:this.progressMs/this.durationMs)*z.sprites);t.drawImage(z.img,z.width*i,0,z.width,z.height,s*this.position.x,this.position.y,this.size.width,this.size.height),t.restore(),this.progressMs+=1e3*e}}class B{constructor(){}}class F extends B{collisionGroup;collidesWith;stationary;onCollision;restitution;collisionLeft=[];collisionRight=[];collisionTop=[];collisionBottom=[];constructor(t,e=[],s=!1,i=()=>{},o=0){super(),this.collisionGroup=t,this.collidesWith=e,this.stationary=s,this.onCollision=i,this.restitution=o}}class P extends B{countdown;constructor(t=0){super(),this.countdown=t}}class U extends B{points;hitPosition;hitDirection;triggerInMs;constructor(t,e,s,i=0){super(),this.points=t,this.hitPosition=e,this.hitDirection=s,this.triggerInMs=i}}var O={};O=new URL("gun_bullet_trail-Sheet.05730235.png",import.meta.url).toString();var W={};W=new URL("gun_bullet.bfef5470.png",import.meta.url).toString();const j=new Image;j.src=t(W);const q={img:j,width:2,height:1},N=new Image;N.src=t(O);const Y={sprites:3,img:N,width:10,height:1};class G extends R{fallOfTimeMs;bulletTrailAnimation={durationMs:225,progressMs:0};constructor(t,e,s=3e3){super(t,{width:5*q.width,height:5*q.height},e,[new F("playerAttack",["mob"],!0,(t,e,s)=>{let i=e.calculateHitbox(),o=t.calculateHitbox(),n=t.vector.x<=0?"left":"right",a="left"===n?{x:o.x,y:o.y}:{x:o.x+o.width,y:o.y},r="left"===n?{x:a.x-i.width,y:a.y}:{x:a.x+i.width,y:a.y};t.addComponents(new P),e.addComponents(new U(20,r,n));let h=new I(r,n,500);h.addComponents(new P(500)),s.marioSystem.entities.push(h)})]),this.fallOfTimeMs=s}calculateHitbox(){let t=this.position.x;return{x:t,y:this.position.y,width:this.size.width,height:this.size.height}}draw(t,e){t.save();let s=this.vector.x>0?-1:1;t.scale(s,1);let i=Math.floor((this.bulletTrailAnimation.progressMs>this.bulletTrailAnimation.durationMs?this.bulletTrailAnimation.progressMs%this.bulletTrailAnimation.durationMs/this.bulletTrailAnimation.durationMs:this.bulletTrailAnimation.progressMs/this.bulletTrailAnimation.durationMs)*Y.sprites);t.drawImage(Y.img,Y.width*i,0,Y.width,Y.height,s*(this.position.x+(this.vector.x>0?-this.size.width:this.size.width)),this.position.y,this.size.width*(Y.width/q.width),this.size.height),t.drawImage(q.img,0,0,q.width,q.height,s*this.position.x,this.position.y,this.size.width,this.size.height),t.restore(),this.bulletTrailAnimation.progressMs+=1e3*e,this.fallOfTimeMs-=1e3*e}}class D extends B{pull;constructor(t){super(),this.pull=t}}class X extends B{strength;dexterity;intelligence;hp;mana;speed;maxHp;maxMana;constructor(t){super(),this.strength=t.strength,this.dexterity=t.dexterity,this.intelligence=t.intelligence,this.hp=t.hp,this.maxHp=t.hp,this.mana=t.mana,this.maxMana=t.mana,this.speed=t.speed}}var K={};K=new URL("walk_drawn_gun__body-Sheet.6002e4f2.png",import.meta.url).toString();var $={};$=new URL("walk_drawn_gun_legs-Sheet.d820a7b4.png",import.meta.url).toString();var V={};V=new URL("sprint_stowed_gun_body_v2-Sheet.d8fcc020.png",import.meta.url).toString();var Q={};Q=new URL("sprint_stowed_gun_legs_v2-Sheet.07759801.png",import.meta.url).toString();var Z={};Z=new URL("stowe_gun_body-Sheet.00c176c4.png",import.meta.url).toString();var J={};J=new URL("draw_gun_body-Sheet.d5fb5e58.png",import.meta.url).toString();var tt={};tt=new URL("jump_drawn_gun_body_v2-Sheet.8a11f581.png",import.meta.url).toString();var te={};te=new URL("jump_drawn_gun_legs-Sheet.1094a8cf.png",import.meta.url).toString();var ts={};ts=new URL("leap_stowed_gun_body-Sheet.7a171eba.png",import.meta.url).toString();var ti={};ti=new URL("leap_stowed_gun_legs-Sheet.d5b2d32e.png",import.meta.url).toString();var to={};to=new URL("ascend_drawn_gun_body.8a9322b7.png",import.meta.url).toString();var tn={};tn=new URL("ascend_drawn_gun_legs.b3268ac4.png",import.meta.url).toString();var ta={};ta=new URL("stale_stowed_gun_body.c56cbeba.png",import.meta.url).toString();var tr={};tr=new URL("stale_drawn_gun_body.243306a2.png",import.meta.url).toString();var th={};th=new URL("stale_standing_legs.6bff9712.png",import.meta.url).toString();var tl={};tl=new URL("butt-attack-drawn-gun-whole-body-Sheet.d4b28379.png",import.meta.url).toString();var tc={};tc=new URL("butt-attack-drawn-gun-stale-whole-body.369091bc.png",import.meta.url).toString();const tp=new Image;tp.src=t(K);const td={sprites:9,img:tp},tm=new Image;tm.src=t($);const tu={sprites:10,img:tm},tg=new Image;tg.src=t(V);const tw={sprites:8,img:tg},tf=new Image;tf.src=t(Q);const ty={sprites:10,img:tf},tx=new Image;tx.src=t(J);const tS={sprites:15,img:tx},tb=new Image;tb.src=t(Z);const tv={sprites:15,img:tb},tM=new Image;tM.src=t(tt);const tk={sprites:5,img:tM},tT=new Image;tT.src=t(te);const t_={sprites:5,img:tT},tE=new Image;tE.src=t(ts);const tC={sprites:5,img:tE},tA=new Image;tA.src=t(ti);const tR={sprites:7,img:tA},tH=new Image;tH.src=t(to);const tL={sprites:1,img:tH},tz=new Image;tz.src=t(tn);const tI={sprites:1,img:tz},tB=new Image;tB.src=t(to);const tF={sprites:1,img:tB},tP=new Image;tP.src=t(tn);const tU={sprites:1,img:tP},tO=new Image;tO.src=t(ta);const tW={sprites:1,img:tO},tj=new Image;tj.src=t(tr);const tq={sprites:1,img:tj},tN=new Image;tN.src=t(th);const tY={sprites:1,img:tN},tG=new Image;tG.src=t(tl);const tD={sprites:7,img:tG},tX=new Image;tX.src=t(tc);const tK={sprites:1,img:tX};class t$ extends R{direction="left";actions={walk:{state:"not-in-use",durationMs:0,completeMs:1125},sprint:{state:"not-in-use",durationMs:0,completeMs:1e3},draw:{state:"not-in-use",durationMs:0,completeMs:750},stowe:{state:"not-in-use",durationMs:0,completeMs:750},jump:{state:"not-in-use",durationMs:0,completeMs:600},leap:{state:"not-in-use",durationMs:0,completeMs:1e3},ascend:{state:"not-in-use",durationMs:0,completeMs:1e3},descend:{state:"not-in-use",durationMs:0,completeMs:1e3},crouch:{state:"not-in-use",durationMs:0,completeMs:1e3},shoot:{state:"not-in-use",durationMs:0,completeMs:1e3},buttAttack:{state:"not-in-use",durationMs:0,completeMs:420}};weapon={state:"drawn"};constructor(t,e={height:140,width:100}){super(t,e,new S(0,0),[new D(1e3),new F("player",["wall"]),new X({strength:1,dexterity:1,intelligence:1,speed:1,hp:100,mana:100})])}calculateHitbox(){let t=this.position.x-this.size.width/2*.5;return{x:t,y:this.position.y-this.size.height,width:this.size.width-.5*this.size.width,height:this.size.height}}decideBodySprite(){switch(!0){case"in-use"===this.actions.buttAttack.state:return{presets:tD,action:this.actions.buttAttack};case"complete"===this.actions.buttAttack.state:return{presets:tK,action:null};case"in-use"===this.actions.jump.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.jump.state&&"not-drawn"===this.weapon.state:return{presets:tk,action:this.actions.jump};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:tC,action:this.actions.leap};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:tL,action:this.actions.leap};case"in-use"===this.actions.ascend.state:return{presets:tL,action:this.actions.ascend};case"in-use"===this.actions.descend.state:return{presets:tF,action:this.actions.descend};case"in-use"===this.actions.stowe.state:return{presets:tv,action:this.actions.stowe};case"in-use"===this.actions.draw.state:return{presets:tS,action:this.actions.draw};case"in-use"===this.actions.walk.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.walk.state&&"not-drawn"===this.weapon.state:return{presets:td,action:this.actions.walk};case"in-use"===this.actions.sprint.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.sprint.state&&"not-drawn"===this.weapon.state:return{presets:tw,action:this.actions.sprint};case"drawn"===this.weapon.state:return{presets:tq,action:null};case"not-drawn"===this.weapon.state:default:return{presets:tW,action:null}}}decideLegsSprite(){if("in-use"===this.actions.buttAttack.state||"complete"===this.actions.buttAttack.state)return null;switch(!0){case"in-use"===this.actions.jump.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.jump.state&&"not-drawn"===this.weapon.state:return{presets:t_,action:this.actions.jump};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:tR,action:this.actions.leap};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:tI,action:this.actions.leap};case"in-use"===this.actions.ascend.state:return{presets:tI,action:this.actions.ascend};case"in-use"===this.actions.descend.state:return{presets:tU,action:this.actions.descend};case"in-use"===this.actions.walk.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.walk.state&&"not-drawn"===this.weapon.state:return{presets:tu,action:this.actions.walk};case"in-use"===this.actions.sprint.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.sprint.state&&"not-drawn"===this.weapon.state:return{presets:ty,action:this.actions.sprint};default:return{presets:tY,action:null}}}draw(t){t.save();let e=this.calculateHitbox();t.fillStyle="grey",t.fillRect(e.x,e.y-20,e.width,10),t.fillStyle="red",t.fillRect(e.x,e.y-20,e.width*(this.getComponent(X).hp/this.getComponent(X).maxHp),10),t.fillStyle="grey",t.fillRect(e.x,e.y-10,e.width,10),t.fillStyle="blue",t.fillRect(e.x,e.y-10,e.width*(this.getComponent(X).mana/this.getComponent(X).maxMana),10),t.lineWidth=2,t.strokeStyle="yellow",t.strokeRect(e.x,e.y-20,e.width,10),t.strokeStyle="yellow",t.strokeRect(e.x,e.y-10,e.width,10),t.imageSmoothingEnabled=!1;let s=1;"right"===this.direction&&(s=-1),"left"===this.direction&&(s=1),t.scale(s,1);let i=this.decideBodySprite(),o=Math.floor((null===i.action?0:i.action.durationMs>i.action.completeMs?i.action.durationMs%i.action.completeMs/i.action.completeMs:i.action.durationMs/i.action.completeMs)*i.presets.sprites);t.drawImage(i.presets.img,20*o,0,20,28,s*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height);let n=this.decideLegsSprite();if(n){let e=Math.floor((null===n.action?0:n.action.durationMs>n.action.completeMs?n.action.durationMs%n.action.completeMs/n.action.completeMs:n.action.durationMs/n.action.completeMs)*n.presets.sprites);t.drawImage(n.presets.img,20*e,0,20,28,s*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}t.restore()}}var tV={};tV=new URL("wall_texture_1.83063d22.png",import.meta.url).toString();const tQ=new Image;tQ.src=t(tV);const tZ={img:tQ,width:20,height:20};class tJ extends R{constructor(t,e){super({x:t.x-.5,y:t.y-.5},{width:e.width+1,height:e.height+1}),this.addComponents(new F("wall",[],!0))}calculateHitbox(){let t=this.position.x;return{x:t,y:this.position.y,width:this.size.width,height:this.size.height}}draw(t){t.save(),t.imageSmoothingEnabled=!1;let e=t.createPattern(tZ.img,"repeat");null!==e&&(t.fillStyle=e),t.drawImage(tZ.img,0,0,tZ.width,tZ.height,this.position.x,this.position.y,this.size.width,this.size.height),t.restore()}}var t0={};t0=new URL("stale_zombie_v1_body.947226c1.png",import.meta.url).toString();var t1={};t1=new URL("walk_zombie_v1_legs-Sheet.578f3c1b.png",import.meta.url).toString();var t2={};t2=new URL("walk_zombie_v1_body-Sheet.545edeb0.png",import.meta.url).toString();var t3={};t3=new URL("dying_zombie_v1_full_body-Sheet.388c852b.png",import.meta.url).toString();var t5={};t5=new URL("dying_zombie_v1_stale_full_body.d9ccbe80.png",import.meta.url).toString();const t4=new Image;t4.src=t(t0);const t8={sprites:1,img:t4},t6=new Image;t6.src=t(t1);const t9={sprites:6,img:t6},t7=new Image;t7.src=t(t2);const et={sprites:6,img:t7},ee=new Image;ee.src=t(t3);const es={sprites:5,img:ee},ei=new Image;ei.src=t(t5);const eo={sprites:1,img:ei};class en extends R{direction="right";actions={walk:{state:"not-in-use",durationMs:0,completeMs:1e3},die:{state:"not-in-use",durationMs:0,completeMs:1e3}};constructor(t,e={height:140,width:140}){super(t,e,new S(0,0),[new D(1e3),new F("mob",["wall"]),new X({strength:1,dexterity:1,intelligence:1,speed:1,hp:100,mana:100})])}calculateHitbox(){let t=this.position.x-this.size.width/2*.2;return{x:t,y:this.position.y-this.size.height,width:this.size.width-.8*this.size.width,height:this.size.height}}decideBodySprite(){switch(!0){case"in-use"===this.actions.die.state:return{presets:es,action:this.actions.die};case"complete"===this.actions.die.state:return{presets:eo,action:null};case"in-use"===this.actions.walk.state:return{presets:et,action:this.actions.walk};default:return{presets:t8,action:null}}}decideLegsSprite(){return"in-use"===this.actions.die.state||"complete"===this.actions.die.state?null:!0==("in-use"===this.actions.walk.state)?{presets:t9,action:this.actions.walk}:{presets:t9,action:null}}draw(t){t.save(),this.calculateHitbox(),t.imageSmoothingEnabled=!1;let e=1;"left"===this.direction&&(e=-1),"right"===this.direction&&(e=1),t.scale(e,1);let s=this.decideBodySprite(),i=Math.floor((null===s.action?0:s.action.durationMs>s.action.completeMs?s.action.durationMs%s.action.completeMs/s.action.completeMs:s.action.durationMs/s.action.completeMs)*s.presets.sprites);t.drawImage(s.presets.img,30*i,0,30,30,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height);let o=this.decideLegsSprite();if(o){let s=Math.floor((null===o.action?0:o.action.durationMs>o.action.completeMs?o.action.durationMs%o.action.completeMs/o.action.completeMs:o.action.durationMs/o.action.completeMs)*o.presets.sprites);t.drawImage(o.presets.img,30*s,0,30,30,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}t.restore()}}class ea{appliesTo(t){return!1}update(t,e,s){throw Error("not implemented")}}class er extends ea{constructor(){super()}appliesTo(t){return t instanceof en}update(t,e,s){let i=t.marioSystem.player;for(let t of e){if(!(t instanceof en))throw Error("#appliesTo not called before update");if(this.updateActionTimers(t,s),t.hasComponent(F)&&0!==t.getComponent(F).collisionBottom.length&&t.vector.y>1e3&&(t.vector.y=0),t.hasComponent(X)&&t.getComponent(X).hp<=0&&"not-in-use"===t.actions.die.state&&(t.hasComponent(F)&&(t.getComponent(F).collisionGroup="cadaver"),t.actions.die.state="in-use",t.vector.x=0),!i||t.hasComponent(X)&&t.getComponent(X).hp<=0)continue;let e=[i].map(e=>({distance:t.distanceTo(e),player:e})).sort((t,e)=>t.distance-e.distance)[0];e.distance<=500?(e.player.position.x<t.position.x&&(t.actions.walk.state="in-use",t.direction="left",t.vector.x-500*s<=-100?t.vector.x=-100:t.vector.x-=500*s),e.player.position.x>t.position.x&&(t.actions.walk.state="in-use",t.direction="right",t.vector.x+500*s>=100?t.vector.x=100:t.vector.x+=500*s)):(t.actions.walk.state="not-in-use",t.actions.walk.durationMs=0,t.vector.x=0)}}updateActionTimers(t,e){"in-use"===t.actions.walk.state&&(t.actions.walk.durationMs+=1e3*e),"in-use"===t.actions.die.state&&(t.actions.die.durationMs+=1e3*e),t.actions.die.durationMs>=t.actions.die.completeMs&&(t.actions.die.state="complete")}}class eh extends ea{constructor(){super()}appliesTo(t){return t.hasComponent(F)}update(t,e,s){let i=e.map(t=>({entity:t,collisionBottom:[],collisionLeft:[],collisionRight:[],collisionTop:[]}));for(let t of e)for(let s of e){if(!t.hasComponent(F)||!s.hasComponent(F))throw Error("#appliesTo not called before update");if(t===s||!s.getComponent(F).collidesWith.some(e=>e===t.getComponent(F).collisionGroup))continue;let e=t.calculateHitbox(),o=s.calculateHitbox(),n=e.x+.5*e.width,a=e.y+.5*e.height,r=o.x+.5*o.width,h=o.y+.5*o.height,l=r-n,c=h-a,p=(o.width+e.width)*.5,d=(o.height+e.height)*.5;if(Math.abs(l)>p||Math.abs(c)>d)continue;let m=t.getComponent(F),u=s.getComponent(F);if(-1===i.findIndex(e=>e.entity===t)||-1===i.findIndex(t=>t.entity===s))throw Error("Collision data not found");if(Math.abs(l/e.width)>Math.abs(c/e.height)){if(l<0){let n=-1===m.collisionLeft.findIndex(t=>t.entity===s),a=i.findIndex(e=>e.entity===t);i[a].collisionLeft.push({entity:s,initialCollision:n});let r=-1===u.collisionRight.findIndex(e=>e.entity===t),h=i.findIndex(t=>t.entity===s);if(i[h].collisionRight.push({entity:t,initialCollision:r}),s.getComponent(F).stationary)continue;let l=e.x-o.x-o.width;s.position.x+=l}else{let n=-1===m.collisionRight.findIndex(t=>t.entity===s),a=i.findIndex(e=>e.entity===t);i[a].collisionRight.push({entity:s,initialCollision:n});let r=-1===u.collisionLeft.findIndex(e=>e.entity===t),h=i.findIndex(t=>t.entity===s);if(i[h].collisionLeft.push({entity:t,initialCollision:r}),s.getComponent(F).stationary)continue;let l=e.x-o.x+e.width;s.position.x+=l}}else if(c<0){let n=-1===m.collisionTop.findIndex(t=>t.entity===s),a=i.findIndex(e=>e.entity===t);i[a].collisionTop.push({entity:s,initialCollision:n});let r=-1===u.collisionBottom.findIndex(e=>e.entity===t),h=i.findIndex(t=>t.entity===s);if(i[h].collisionBottom.push({entity:t,initialCollision:r}),s.getComponent(F).stationary)continue;let l=e.y-o.height-o.y;s.position.y+=l}else{let n=-1===m.collisionBottom.findIndex(t=>t.entity===s),a=i.findIndex(e=>e.entity===t);i[a].collisionBottom.push({entity:s,initialCollision:n});let r=-1===u.collisionTop.findIndex(e=>e.entity===t),h=i.findIndex(t=>t.entity===s);if(i[h].collisionTop.push({entity:t,initialCollision:r}),s.getComponent(F).stationary)continue;let l=e.y+e.height-o.y;s.position.y+=l}}for(let t of e){let e=i.findIndex(e=>e.entity===t);if(-1===e)throw Error("Collision data not found");let s=i[e],o=t.getComponent(F);o.collisionBottom=s.collisionBottom,o.collisionTop=s.collisionTop,o.collisionLeft=s.collisionLeft,o.collisionRight=s.collisionRight}for(let s of e){let e=s.getComponent(F);[...e.collisionBottom,...e.collisionTop,...e.collisionLeft,...e.collisionRight].filter(t=>t.initialCollision).forEach(i=>e.onCollision(s,i.entity,t))}}}class el extends ea{constructor(){super()}appliesTo(t){return t.hasComponent(P)}update(t,e,s){for(let i of e){if(!i.hasComponent(P))throw Error("#appliesTo not called before update");let e=i.getComponent(P);e.countdown-=1e3*s,e.countdown<=0&&t.marioSystem.entities.splice(t.marioSystem.entities.indexOf(i),1)}}}class ec extends ea{constructor(){super()}appliesTo(t){return t.hasComponent(D)}update(t,e,s){for(let t of e){let e=t.getComponent(D).pull;t.vector.y+=e*s}}}class ep extends ea{constructor(){super()}appliesTo(t){return!0}update(t,e,s){for(let t of e){let e=t.vector;t.position.x+=e.x*s,t.position.y+=e.y*s}}}class ed{input=new Set;constructor(){document.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":return this.input.add("up");case"ArrowLeft":return this.input.add("left");case"ArrowDown":return this.input.add("down");case"ArrowRight":return this.input.add("right");case"s":return this.input.add("S");case"f":return this.input.add("F")}}),document.addEventListener("keyup",t=>{switch(t.key){case"ArrowUp":return this.input.delete("up");case"ArrowLeft":return this.input.delete("left");case"ArrowDown":return this.input.delete("down");case"ArrowRight":return this.input.delete("right");case"s":return this.input.delete("S");case"f":return this.input.delete("F")}})}getActions(t,e){return this.determineActions(this.input,t,e)}determineActions(t,e,s){let i=new Set;for(let s of t)switch(s){case"left":["jump","leap"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&i.add("sprint-left"),"drawn"===e.weapon.state&&i.add("walk-left"),i.delete("walk-right"),i.delete("sprint-right"));break;case"right":["jump","leap"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&i.add("sprint-right"),"drawn"===e.weapon.state&&i.add("walk-right"),i.delete("walk-left"),i.delete("sprint-left"));break;case"down":["jump","buttAttack","leap","stowe","draw","shoot"].every(t=>"not-in-use"===e.actions[t].state)&&"drawn"===e.weapon.state&&i.add("butt-attack");break;case"up":["jump","leap","ascend","descend","stowe","draw","shoot"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&i.add("draw-weapon"),"drawn"===e.weapon.state&&i.add("stowe-weapon"),i.delete("shoot"),i.delete("jump"),i.delete("leap"));break;case"S":["jump","leap","ascend","descend","draw","shoot"].every(t=>"not-in-use"===e.actions[t].state)&&(("not-drawn"===e.weapon.state||"in-use"===e.actions.stowe.state)&&i.add("leap"),"drawn"===e.weapon.state&&i.add("jump"),i.delete("shoot"),i.delete("draw-weapon"),i.delete("stowe-weapon"));break;case"F":["jump","ascend","descend","stowe","draw","leap"].every(t=>"not-in-use"===e.actions[t].state)&&"drawn"===e.weapon.state&&(i.delete("jump"),i.add("shoot"))}return i.forEach(t=>{s.has(t)&&i.delete(t)}),i}}var em={};em=new URL("ground_crumble_effect_v2-Sheet.ce4cbca3.png",import.meta.url).toString();const eu=new Image;eu.src=t(em);const eg={sprites:6,img:eu,width:50,height:12};class ew extends R{durationMs;progressMs=0;constructor(t,e=500,s={height:50,width:250}){super(t,s,new S(0,0),[new P(e),new F("playerAttack",["mob"],!0,(t,e)=>{let s=e.calculateHitbox(),i=t.calculateHitbox(),o="left";e.vector.y=-200,i.x+i.width/2<s.x+s.width/2&&(e.vector.x=500,o="right"),i.x+i.width/2>s.x+s.width/2&&(e.vector.x=-500,o="left"),e.addComponents(new U(20,{x:e.position.x,y:e.position.y},o))})]),this.durationMs=e}calculateHitbox(){let t=this.position.x-this.size.width/2;return{x:t,y:this.position.y-this.size.height,width:this.size.width,height:this.size.height}}draw(t,e){t.save(),t.imageSmoothingEnabled=!1;let s=Math.floor((this.progressMs>this.durationMs?this.progressMs%this.durationMs/this.durationMs:this.progressMs/this.durationMs)*eg.sprites);t.drawImage(eg.img,eg.width*s,0,eg.width,eg.height,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.restore(),this.progressMs+=1e3*e}}class ef extends ea{inputHandler=new ed;actionCooldowns=new Map;constructor(){super()}appliesTo(t){return t instanceof t$}update(t,e,s){for(let i of e){if(!(i instanceof t$))throw Error("#update called with non Player instance");this.updateActionTimers(i,s),this.updateActionCooldowns(s);let e=this.inputHandler.getActions(i,this.actionCooldowns),o=["walk-left","walk-right"],n=["sprint-left","sprint-right"];if(![...o,...n].some(t=>e.has(t))&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.vector.x=0),o.some(t=>e.has(t))||(i.actions.walk.state="not-in-use",i.actions.walk.durationMs=0),n.some(t=>e.has(t))||(i.actions.sprint.state="not-in-use",i.actions.sprint.durationMs=0),e.has("crouch")||(i.actions.crouch.state="not-in-use",i.actions.crouch.durationMs=0),i.hasComponent(F)&&i.getComponent(F).collisionBottom.every(t=>!0===t.initialCollision)&&this.actionCooldowns.set("leap",500),i.hasComponent(F)&&0===i.getComponent(F).collisionBottom.length&&(0!==i.getComponent(F).collisionLeft.length&&i.getComponent(F).collisionLeft.every(t=>!0===t.initialCollision)&&(i.vector.x=200),0!==i.getComponent(F).collisionRight.length&&i.getComponent(F).collisionRight.every(t=>!0===t.initialCollision)&&(i.vector.x=-200)),i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length){if("complete"===i.actions.buttAttack.state){let e=new ew({x:i.position.x,y:i.position.y});t.marioSystem.entities.push(e)}i.actions.ascend.state="not-in-use",i.actions.ascend.durationMs=0,i.actions.descend.state="not-in-use",i.actions.descend.durationMs=0,i.actions.leap.state="not-in-use",i.actions.leap.durationMs=0,i.actions.buttAttack.state="not-in-use",i.actions.buttAttack.durationMs=0,i.vector.y=0}if("complete"===i.actions.jump.state&&(i.vector.y=-600,i.actions.ascend.state="in-use","left"===i.direction&&(i.vector.x=-300),"right"===i.direction&&(i.vector.x=300)),"complete"===i.actions.draw.state&&(i.weapon.state="drawn"),i.vector.y>0&&(i.actions.ascend.state="not-in-use",i.actions.ascend.durationMs=0),i.hasComponent(F)&&0===i.getComponent(F).collisionBottom.length&&i.vector.y>0&&(i.actions.descend.state="in-use"),"in-use"===i.actions.buttAttack.state&&(i.vector.y=0,i.vector.x=0),"complete"===i.actions.buttAttack.state&&(i.vector.y=1400),e.has("shoot")){let e="right"===i.direction?1e3:-1e3,s="right"===i.direction?i.position.x+i.size.width/2:i.position.x-i.size.width/2;t.marioSystem.entities.push(new G({x:s,y:i.position.y-i.size.height/2-i.size.height/50},new S(e,0))),this.actionCooldowns.set("shoot",100),i.actions.shoot.state="in-use"}e.has("walk-left")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.direction="left",i.vector.x=-250,i.actions.walk.state="in-use"),e.has("sprint-left")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.direction="left",i.vector.x=-500,i.actions.sprint.state="in-use"),e.has("walk-right")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.direction="right",i.vector.x=250,i.actions.walk.state="in-use"),e.has("sprint-right")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.direction="right",i.vector.x=500,i.actions.sprint.state="in-use"),e.has("jump")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.actions.jump.state="in-use"),e.has("leap")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.actions.leap.state="in-use","left"===i.direction&&(i.vector.x=-1e3),"right"===i.direction&&(i.vector.x=1e3),i.vector.y=-275),e.has("draw-weapon")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.actions.draw.state="in-use"),e.has("stowe-weapon")&&i.hasComponent(F)&&0!==i.getComponent(F).collisionBottom.length&&(i.actions.stowe.state="in-use",i.weapon.state="not-drawn"),e.has("butt-attack")&&i.hasComponent(F)&&0===i.getComponent(F).collisionBottom.length&&("in-use"===i.actions.descend.state||"in-use"===i.actions.ascend.state)&&(i.actions.buttAttack.state="in-use"),this.resetCompletedActions(i),this.resetCompletedCooldowns()}}updateActionTimers(t,e){"in-use"===t.actions.walk.state&&(t.actions.walk.durationMs+=1e3*e),"in-use"===t.actions.sprint.state&&(t.actions.sprint.durationMs+=1e3*e),"in-use"===t.actions.draw.state&&(t.actions.draw.durationMs+=1e3*e),"in-use"===t.actions.stowe.state&&(t.actions.stowe.durationMs+=1e3*e),"in-use"===t.actions.jump.state&&(t.actions.jump.durationMs+=1e3*e),"in-use"===t.actions.leap.state&&(t.actions.leap.durationMs+=1e3*e),"in-use"===t.actions.crouch.state&&(t.actions.crouch.durationMs+=1e3*e),"in-use"===t.actions.ascend.state&&(t.actions.ascend.durationMs+=1e3*e),"in-use"===t.actions.descend.state&&(t.actions.descend.durationMs+=1e3*e),"in-use"===t.actions.shoot.state&&(t.actions.shoot.durationMs+=1e3*e),"in-use"===t.actions.buttAttack.state&&(t.actions.buttAttack.durationMs+=1e3*e),t.actions.draw.durationMs>=t.actions.draw.completeMs&&(t.actions.draw.state="complete"),t.actions.stowe.durationMs>=t.actions.stowe.completeMs&&(t.actions.stowe.state="complete"),t.actions.jump.durationMs>=t.actions.jump.completeMs&&(t.actions.jump.state="complete"),t.actions.crouch.durationMs>=t.actions.crouch.completeMs&&(t.actions.crouch.state="complete"),t.actions.shoot.durationMs>=t.actions.shoot.completeMs&&(t.actions.shoot.state="complete"),t.actions.buttAttack.durationMs>=t.actions.buttAttack.completeMs&&(t.actions.buttAttack.state="complete")}updateActionCooldowns(t){this.actionCooldowns.forEach((e,s)=>{this.actionCooldowns.set(s,e-1e3*t)})}resetCompletedActions(t){"complete"===t.actions.walk.state&&(t.actions.walk.state="not-in-use",t.actions.walk.durationMs=0),"complete"===t.actions.sprint.state&&(t.actions.sprint.state="not-in-use",t.actions.sprint.durationMs=0),"complete"===t.actions.draw.state&&(t.actions.draw.state="not-in-use",t.actions.draw.durationMs=0),"complete"===t.actions.stowe.state&&(t.actions.stowe.state="not-in-use",t.actions.stowe.durationMs=0),"complete"===t.actions.jump.state&&(t.actions.jump.state="not-in-use",t.actions.jump.durationMs=0),"complete"===t.actions.leap.state&&(t.actions.leap.state="not-in-use",t.actions.leap.durationMs=0),"complete"===t.actions.crouch.state&&(t.actions.crouch.state="not-in-use",t.actions.crouch.durationMs=0),"complete"===t.actions.ascend.state&&(t.actions.ascend.state="not-in-use",t.actions.ascend.durationMs=0),"complete"===t.actions.descend.state&&(t.actions.descend.state="not-in-use",t.actions.descend.durationMs=0),"complete"===t.actions.shoot.state&&(t.actions.shoot.state="not-in-use",t.actions.shoot.durationMs=0)}resetCompletedCooldowns(){this.actionCooldowns.forEach((t,e)=>{t<=0&&this.actionCooldowns.delete(e)})}}class ey extends ea{constructor(){super()}appliesTo(t){return t.hasComponent(X)&&t.hasComponent(U)}update(t,e,s){for(let t of e){if(!t.hasComponent(X)||!t.hasComponent(U))throw Error("#appliesTo not called before update");let e=t.getComponent(X),i=t.getComponent(U);i.triggerInMs<=0&&(e.hp-=i.points,t.removeComponent(i)),e.hp,i.triggerInMs-=1e3*s}}}class ex{game;entities=[];player=null;gravitySystem=new ec;collisionSystem=new eh;deleteSystem=new el;moveSystem=new ep;playerSystem=new ef;effectSystem=new ey;zombieV1Behavior=new er;constructor(t){this.game=t,this.setupLevel({height:1e3,width:7e3,entities:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,99,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,98,98,98,98,98,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]})}setupLevel(t){for(let e=0;e<t.entities.length;e++)for(let s=0;s<t.entities[e].length;s++){let i={width:t.width/t.entities[e].length,height:t.height/t.entities.length},o={x:i.width*s,y:i.height*e};0!==t.entities[e][s]&&(99===t.entities[e][s]&&(this.player=new t$({x:i.width*s,y:i.height*e})),98===t.entities[e][s]&&this.entities.push(new en({x:i.width*s,y:i.height*e})),1===t.entities[e][s]&&this.entities.push(new tJ(o,i)))}}update(t){if(null!==this.player){for(let e of[this.deleteSystem,this.playerSystem,this.zombieV1Behavior,this.gravitySystem,this.effectSystem,this.moveSystem,this.collisionSystem]){let s=[this.player,...this.entities].filter(e.appliesTo);e.update(this.game,s,t)}this.entities=this.entities.filter(t=>!(t instanceof G)||t instanceof G&&t.fallOfTimeMs>0)}}draw(t,e){if(null===this.player)return;let s=this.game.gameWidth/2,i=this.game.gameHeight/2;for(let o of[this.player,...this.entities])t.translate(-(this.player.position.x-s),-(this.player.position.y-i)),o.draw(t,e),t.resetTransform()}}n=class{gameWidth;gameHeight;mainCtx;mousePos;players=[{name:"mami",lvl:1,stats:{maxHp:60,maxStamina:60,strength:1,intelligence:1,dodgeChance:.1,hitRate:.9}},{name:"papi",lvl:1,stats:{maxHp:60,maxStamina:60,strength:1,intelligence:1,dodgeChance:.1,hitRate:.9}}];mapScreen=new v(this);pauseScreen=new E(this);battleSystem=new A(this);marioSystem;input=new Set;state="RUNNING";visible=!0;constructor(t,e,s,i={x:t/2,y:e/2}){this.gameWidth=t,this.gameHeight=e,this.mainCtx=s,this.mousePos=i;let o=M("gameScreen");this.marioSystem=new ex(this),window.addEventListener("resize",()=>{this.gameHeight=o.clientHeight,this.gameWidth=o.clientWidth}),window.addEventListener("visibilitychange",()=>{document.hidden?this.visible=!1:this.visible=!0}),o.addEventListener("click",()=>{this.input.add("leftClick")}),this.start()}start(){}update(t){this.visible&&this.marioSystem.update(t)}clearInput(){this.input.clear()}draw(t,e){this.marioSystem.draw(t,e)}};const eS=document.querySelector("#gameScreen"),eb=eS.getContext("2d");eb.imageSmoothingEnabled=!0,eb.imageSmoothingQuality="high";const ev=window.innerWidth,eM=window.innerHeight;eS.width=ev,eS.height=eM;const ek=new n(ev,eM,eb);let eT=0;requestAnimationFrame(function t(e){let s=(e-eT)/1e3;eT=e,eb.clearRect(0,0,ev,eM),ek.update(s),ek.draw(eb,s),requestAnimationFrame(t)});
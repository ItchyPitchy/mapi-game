function t(t){return t&&t.__esModule?t.default:t}var e,s,i,a,o,n={};n=new URL("stockholm_map.2976de6e.png",import.meta.url).toString();const r=(t,e)=>{let s=Math.ceil(t);return Math.floor(Math.random()*(Math.floor(e)-s+1)+s)};s=class{position;size;rotation;constructor(t,e,s=0){this.position=t,this.size=e,this.rotation=s}distanceTo(t){return Math.sqrt(Math.pow(this.position.x-t.x,2)+Math.pow(this.position.y-t.y,2))}draw(t,e){throw Error("#draw not implemented yet!")}};const h={archeologist:{type:"archeologist",skills:[{name:"Hit",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=0,fixedBonus:e=0})=>({type:"damage",points:10*t+e}),unlockLvl:1},{name:"Throw Dirt",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"blind",duration:2}),unlockLvl:1},{name:"Examine",validTarget:["enemy"],numberOfTargets:-1,generateSkillEffect:()=>({type:"weaken",duration:1}),unlockLvl:2},{name:"Dig",validTarget:["allies"],numberOfTargets:1,generateSkillEffect:()=>({type:"evade",duration:2}),unlockLvl:3}]},medic:{type:"medic",skills:[{name:"Stitch",validTarget:["allies","self"],numberOfTargets:1,generateSkillEffect:()=>({type:"heal",points:15}),unlockLvl:1},{name:"Cut",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=0,fixedBonus:e=0})=>({type:"damage",points:15*t+e}),unlockLvl:1},{name:"Drain Blood",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"bleed",points:10,duration:3}),unlockLvl:2},{name:"Restrain",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"snare",duration:1}),unlockLvl:3},{name:"Drug",validTarget:["enemy"],numberOfTargets:2,generateSkillEffect:()=>({type:"confuse",duration:1}),unlockLvl:4}]},zombie:{type:"zombie",skills:[{name:"Scratch",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=0,fixedBonus:e=0})=>({type:"damage",points:15*t+e}),unlockLvl:1}]}};var l={};l=new URL("zombie_spritesheet.cc0599cc.png",import.meta.url).toString();class c extends s{lvl;size={height:100,width:100};name="Zombie";role=h.zombie;hp;stats;effects=[];spritesheet=new Image;constructor(e,s,i=0,a={height:50,width:50}){super(s,a,i),this.lvl=e,this.spritesheet.src=t(l);let o=this.generateStatsFromLvl(e);this.hp=o.maxHp,this.stats=o}generateStatsFromLvl(t){return{maxHp:40*t,maxStamina:40*t,strength:1*t,intelligence:1*t,hitRate:1-.4*t,dodgeChance:1-.9*t}}draw({ctx:t,offsetX:e=0,offsetY:s=0},i=!1){if(t.save(),t.translate(e,s),t.imageSmoothingEnabled=!1,i){t.shadowColor="yellow",t.shadowBlur=0;let e=[-2,2];for(let s=0;s<e.length;s++){t.shadowOffsetX=e[s];for(let s=0;s<e.length;s++)t.shadowOffsetY=e[s],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore()}}var p={};p=new URL("mami_spritesheet.b49e3f9a.png",import.meta.url).toString();class d extends s{lvl;stats;name="Mami";role=h.medic;hp;effects=[];spritesheet=new Image;constructor(e,s,i,a=0,o={height:96,width:96}){super(i,o,a),this.lvl=e,this.stats=s,this.spritesheet.src=t(p),this.hp=s.maxHp}draw({ctx:t,offsetX:e=0,offsetY:s=0},i=!1){if(t.save(),t.translate(e,s),t.imageSmoothingEnabled=!1,i){t.shadowColor="yellow",t.shadowBlur=0;let e=[-2,2];for(let s=0;s<e.length;s++){t.shadowOffsetX=e[s];for(let s=0;s<e.length;s++)t.shadowOffsetY=e[s],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore()}}var m={};m=new URL("papi_spritesheet.5fe8d860.png",import.meta.url).toString();class u extends s{lvl;stats;name="Papi";role=h.archeologist;hp;effects=[];spritesheet=new Image;constructor(e,s,i,a=0,o={height:96,width:96}){super(i,o,a),this.lvl=e,this.stats=s,this.spritesheet.src=t(m),this.hp=s.maxHp}draw({ctx:t,offsetX:e=0,offsetY:s=0},i=!1){if(t.save(),t.translate(e,s),t.imageSmoothingEnabled=!1,i){t.shadowColor="yellow",t.shadowBlur=0;let e=[-2,2];for(let s=0;s<e.length;s++){t.shadowOffsetX=e[s];for(let s=0;s<e.length;s++)t.shadowOffsetY=e[s],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore()}}class g{background;foes;players;constructor(t,e,s){this.background=s,this.foes=this.generateFoes(t,e.foes),this.players=this.generatePlayers(t,e.players)}generateFoes(t,e){let s=r(e.min,e.max),i=[];for(let t=0;t<s;t++){let t=Math.floor(Math.random()*e.types.length),s=e.types[t];if(!s)continue;let a=r(s.lvl.min,s.lvl.max);i.push({type:s.type,lvl:a})}let a=t.gameHeight/3,o=i.length%3==0?3:i.length%3;return i.map((t,e)=>{let s=Math.floor(e/3)+1,n=Math.ceil(i.length/3)===s?o:3,r=a/n;switch(t.type){case"zombie":case"brute":return new c(t.lvl,{x:40+70*s-e%3*(60/n),y:e%3*r+r/2+2*a})}})}generatePlayers(t,e){let s=t.gameHeight/3,i=e.length%3==0?3:e.length%3;return e.map((a,o)=>{let n=Math.floor(o/3)+1,r=Math.ceil(e.length/3)===n?i:3,h=s/r,l=o%3*h+h/2+2*s,c=t.gameWidth-70*n-o%3*(60/r);switch(a.name){case"mami":return new d(a.lvl,a.stats,{x:c,y:l});case"papi":return new u(a.lvl,a.stats,{x:c,y:l})}})}drawBackground({game:t,ctx:e,offsetX:s=0,offsetY:i=0}){let a=Math.min(t.gameWidth/this.background.width,t.gameHeight/this.background.height),o=(t.gameWidth-this.background.width*a)/2,n=(t.gameHeight-this.background.height*a)/2;e.translate(s,i),e.drawImage(this.background,0,0,this.background.width,this.background.height,o,n,this.background.width*a,this.background.height*a),e.resetTransform()}}var w={};w=new URL("ahlens_map.e96a496f.png",import.meta.url).toString();class f extends g{constructor(e,s){let i=new Image;i.src=t(w),super(e,{players:s,foes:{min:3,max:4,types:[{type:"zombie",lvl:{min:1,max:2}},{type:"brute",lvl:{min:1,max:2}}]}},i)}}(e=i||(i={}))[e.BATTLE=0]="BATTLE";class y{texture;stops=[{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:577,y:206},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:548,y:252},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:467,y:310},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:493,y:376},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:335,y:384},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:362,y:460},{type:i.BATTLE,setupBattle:t=>new f(t.game,t.players),x:430,y:452}];currentStop=this.stops[0];player={originPos:{x:this.stops[0].x,y:this.stops[0].y},queue:[]};constructor(){let e=new Image;e.src=t(n),this.texture=e}}var S={};S=new URL("player.8afcec90.png",import.meta.url).toString(),a=class{constructor(){}};class x extends a{x;y;constructor(t,e){super(),this.x=t,this.y=e}magnitude(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}dot(t){return this.x*t.x+this.y*t.y}norm(){return{x:this.x/this.magnitude(),y:this.y/this.magnitude()}}normalize(){let t=this.norm();return new x(t.x,t.y)}}const b=["up","left","down","right","esc","enter"];class v{game;map=new y;playerTexture;constructor(e){this.game=e;let s=new Image;s.src=t(S),this.playerTexture=s}update(t){if(b.some(t=>this.game.input.has(t))&&this.game.input.forEach(t=>{let e=this.map.stops.indexOf(this.map.currentStop),s=this.map.stops.length-1===e?null:{stop:this.map.stops[e+1],vectorTo:new x(this.map.stops[e+1].x-this.map.currentStop.x,this.map.stops[e+1].y-this.map.currentStop.y)},i=0===e?null:{stop:this.map.stops[e-1],vectorTo:new x(this.map.stops[e-1].x-this.map.currentStop.x,this.map.stops[e-1].y-this.map.currentStop.y)};switch(t){case"up":(s&&s.vectorTo.y<0||i&&i.vectorTo.y<0)&&(s&&i?s.vectorTo.norm().y<i.vectorTo.norm().y?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"down":(s&&s.vectorTo.y>0||i&&i.vectorTo.y>0)&&(s&&i?s.vectorTo.norm().y>i.vectorTo.norm().y?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"left":(s&&s.vectorTo.x<0||i&&i.vectorTo.x<0)&&(s&&i?s.vectorTo.norm().x<i.vectorTo.norm().x?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"right":(s&&s.vectorTo.x>0||i&&i.vectorTo.x>0)&&(s&&i?s.vectorTo.norm().x>i.vectorTo.norm().x?this.map.currentStop=s.stop:this.map.currentStop=i.stop:s?this.map.currentStop=s.stop:i&&(this.map.currentStop=i.stop));break;case"esc":this.game.state="PAUSE_SCREEN",this.game.pauseScreen.show();break;case"enter":{let t=this.map.currentStop.setupBattle({game:this.game,players:this.game.players});this.game.battleSystem.battle.active=t,this.game.state="BATTLE_SCENE"}}let a=this.map.player.queue.indexOf(this.map.currentStop);a>=0?this.map.player.queue=this.map.player.queue.slice(0,a+1):(this.map.currentStop.x!==this.map.player.originPos.x||this.map.currentStop.y!==this.map.player.originPos.y)&&this.map.player.queue.push(this.map.currentStop)}),0!==this.map.player.queue.length){let e=new x(this.map.player.queue[0].x-this.map.player.originPos.x,this.map.player.queue[0].y-this.map.player.originPos.y),s=e.norm(),i=new x(170*s.x*t,170*s.y*t);i.magnitude()>e.magnitude()?(this.map.player.originPos.x=this.map.player.queue[0].x,this.map.player.originPos.y=this.map.player.queue[0].y,this.map.player.queue.shift()):(this.map.player.originPos.x+=i.x,this.map.player.originPos.y+=i.y)}}draw(t){let e=Math.min(this.game.gameWidth/this.map.texture.width,this.game.gameHeight/this.map.texture.height),s=(this.game.gameWidth-this.map.texture.width*e)/2,i=(this.game.gameHeight-this.map.texture.height*e)/2;t.clearRect(0,0,this.game.gameWidth,this.game.gameHeight),t.drawImage(this.map.texture,0,0,this.map.texture.width,this.map.texture.height,s,i,this.map.texture.width*e,this.map.texture.height*e);for(let e=0;e<this.map.stops.length;e++)this.map.stops[e+1]&&(t.save(),t.beginPath(),t.setLineDash([5,3]),t.moveTo(this.map.stops[e].x+s,this.map.stops[e].y+i),t.lineTo(this.map.stops[e+1].x+s,this.map.stops[e+1].y+i),t.lineWidth=3,t.stroke(),t.restore()),t.save(),t.fillStyle=this.map.currentStop===this.map.stops[e]?"red":"orange",t.beginPath(),t.arc(this.map.stops[e].x+s,this.map.stops[e].y+i,5,0,2*Math.PI),t.fill(),t.restore();t.drawImage(this.playerTexture,this.map.player.originPos.x+s-17.5,this.map.player.originPos.y+i-40,35,35)}}const k=t=>{let e=document.getElementById(t);if(null===e)throw Error(`Could not find element with id ${t}`);return e},T=k("pauseScreen"),E=k("options"),M=["up","left","down","right","enter","esc"];class _{game;options=[{id:"continue",text:"Continue"},{id:"map",text:"Map"},{id:"settings",text:"Settings"},{id:"credits",text:"Credits"}];selectedOption="continue";constructor(t){this.game=t;let e=k("options");for(let t of this.options){let s=document.createElement("span");t.id===this.selectedOption&&s.setAttribute("data-selected","selected"),s.setAttribute("data-optionId",t.id),s.textContent=t.text,s.addEventListener("mouseenter",()=>{this.handleSwitchSelectedOption(()=>t)}),s.addEventListener("click",()=>{this.handleSubmitOption()}),e.appendChild(s)}}show(){T.style.display="flex"}hide(){T.style.display="none"}handleSwitchSelectedOption(t){let e=E.querySelector("[data-selected='selected']");if(e){e.removeAttribute("data-selected");let s=e.getAttribute("data-optionId"),i=this.options.findIndex(t=>t.id===s),a=t(-1===i?null:i),o=E.querySelector(`[data-optionId='${a.id}']`);o&&(this.selectedOption=a.id,o.setAttribute("data-selected","selected"))}}handleSubmitOption(){switch(this.selectedOption){case"continue":this.hide(),this.game.state="RUNNING";break;case"map":this.hide(),this.game.state="MAP_SCREEN"}}update(){M.some(t=>this.game.input.has(t))&&this.game.input.forEach(t=>{switch(t){case"up":this.handleSwitchSelectedOption(t=>0===t||null===t?this.options[this.options.length-1]:this.options[t-1]);break;case"down":this.handleSwitchSelectedOption(t=>t===this.options.length-1||null===t?this.options[0]:this.options[t+1]);break;case"esc":this.hide(),this.game.state="RUNNING";break;case"enter":this.handleSubmitOption()}})}}const L=["up","left","down","right","esc","enter"];class A{game;battle={active:null,queue:[]};state={name:"SLEEP"};animations=[{type:"commence-battle",durationMs:1200,timePassedMs:0}];constructor(t){this.game=t}update(t){if(this.battle.active&&(this.updateAnimations(t).deleted.some(t=>"commence-battle"===t.type)&&(this.state=this.calculateNextState(this.battle.active)),L.some(t=>this.game.input.has(t))))for(let t of this.game.input)switch(this.state.name){case"SLEEP":case"ENEMY_TURN":break;case"PLAYER_SELECT_SKILL":switch(t){case"up":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=s.indexOf(e),a=s.at(i-1);a&&(this.state.focusedSkill=a);break}case"down":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=s.indexOf(e),a=s.at(i-2+1);a&&(this.state.focusedSkill=a);break}case"left":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=t.findIndex(t=>t.some(t=>t===e)),a=s.indexOf(e),o=t.at(i-1)?.at(a);o&&(this.state.focusedSkill=o);break}case"right":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,s=t.find(t=>t.some(t=>t===e));if(!s)throw Error("#columnWithFocusedSkill is undefined");let i=t.findIndex(t=>t.some(t=>t===e)),a=s.indexOf(e),o=t.at(i-t.length)?.at(a);o&&(this.state.focusedSkill=o);break}case"esc":this.game.state="PAUSE_SCREEN",this.game.pauseScreen.show();break;case"enter":this.state={name:"PLAYER_SELECT_TARGET",characterTurn:this.state.characterTurn,selectedSkill:this.state.focusedSkill,selectedTargets:[],focusedTarget:this.battle.active.foes[0]}}break;case"PLAYER_SELECT_TARGET":{let e=[...this.battle.active.players,...this.battle.active.foes],s=e.indexOf(this.state.focusedTarget),[i]=e.splice(s,1);if(!i)throw Error("#currentlySelectedTarget is undefined!");let a=e.map(t=>({target:t,vectorTo:new x(t.position.x-i.position.x,t.position.y-i.position.y)}));switch(t){case"up":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.y)>Math.abs(e.x)}).filter(t=>t.vectorTo.y<0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"down":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.y)>Math.abs(e.x)}).filter(t=>t.vectorTo.y>0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"left":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.x)>Math.abs(e.y)}).filter(t=>t.vectorTo.x<0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"right":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.x)>Math.abs(e.y)}).filter(t=>t.vectorTo.x>0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"enter":this.state.selectedTargets.push(this.state.focusedTarget),this.state.selectedTargets.length>=2&&this.executeAction(this.state);break;case"esc":this.game.state="PAUSE_SCREEN",this.game.pauseScreen.show()}}}}updateAnimations(t){this.animations=this.animations.map(e=>({...e,timePassedMs:e.timePassedMs+1e3*t}));let e=this.animations.reduce((t,e)=>e.timePassedMs>=e.durationMs?{...t,finished:[...t.finished,e]}:{...t,inProgress:[...t.inProgress,e]},{inProgress:[],finished:[]});return this.animations=e.inProgress,{deleted:e.finished}}calculateNextState(t){let e=t.players[0],s=e.role.skills;return{name:"PLAYER_SELECT_SKILL",characterTurn:e,focusedSkill:s[0]}}mapToSkillSet(t){let e=Array(t.length%2==0?t.length:t.length+t.length%2).fill(null);for(let s=0;s<e.length;s++)t[s]&&(e[s]=t[s]);let s=e.length/2,i=[];for(let t=0;t<s;t++)i.push(e.slice(2*t,2));return i}executeAction(t){t.selectedTargets.forEach(e=>{e.effects.push(t.selectedSkill.generateSkillEffect({}))})}draw(t){if(this.battle.active){if(t.clearRect(0,0,this.game.gameWidth,this.game.gameHeight),!this.animations.some(t=>"commence-battle"===t.type))for(let e of(t.imageSmoothingEnabled=!1,this.battle.active.drawBackground({ctx:t,game:this.game}),[...this.battle.active.foes,...this.battle.active.players])){let s="PLAYER_SELECT_TARGET"===this.state.name&&this.state.focusedTarget===e;e.draw({ctx:t},s)}for(let e of this.animations){let s=Math.min(e.timePassedMs/e.durationMs,1);if("commence-battle"===e.type){let e=this.game.gameWidth*s-this.game.gameWidth;t.imageSmoothingEnabled=!1,this.battle.active.drawBackground({ctx:t,game:this.game,offsetX:-e,offsetY:0});let i=this.game.gameWidth-this.game.gameWidth*s;for(let e of[...this.battle.active.foes,...this.battle.active.players])e.draw({ctx:t,offsetX:-i,offsetY:0})}}if("PLAYER_SELECT_SKILL"===this.state.name){let e=this.mapToSkillSet(this.state.characterTurn.role.skills);for(let s=0;s<e.length;s++)for(let i=0;i<2;i++){let a=this.game.gameWidth/e.length;t.save(),t.fillStyle="lightgray",t.lineWidth=5,t.strokeStyle="black",t.fillRect(a*s,50*i,a,50),t.strokeRect(a*s+2.5,50*i+2.5,a-5,45),t.restore();let o=e[s][i];o&&(t.save(),t.font="30px serif",t.textAlign="center",t.fillStyle="black",t.fillText(o.name,a*s+a/2,50*i+40),t.restore())}for(let s=0;s<e.length;s++)for(let i=0;i<2;i++){let a=this.game.gameWidth/e.length;t.save(),t.lineWidth=5,t.strokeStyle="red",e[s][i]===this.state.focusedSkill&&t.strokeRect(a*s+2.5,50*i+2.5,a-5,45),t.restore()}}}}}class C{position;size;vector;components;constructor(t,e,s=new x(0,0),i=[]){this.position=t,this.size=e,this.vector=s,this.components=i}distanceTo(t){return Math.sqrt(Math.pow(this.position.x-t.position.x,2)+Math.pow(this.position.y-t.position.y,2))}getComponent(t){for(let e of this.components)if(e instanceof t)return e;throw Error(`Failed to get component type ${t}. Please run hasComponent first!`)}addComponents(...t){for(let e of t)this.components.push(e)}hasComponent(t){for(let e of this.components)if(e instanceof t)return!0;return!1}removeComponent(t){this.components=this.components.filter(e=>e instanceof t)}calculateHitbox(){throw Error("#calculateHitbox not implemented yet")}draw(t){throw Error("#draw not implemented yet")}}class R{constructor(){}}class H extends R{pull;constructor(t){super(),this.pull=t}}class z extends R{restitution;stationary;collisionLeft=!1;collisionRight=!1;collisionTop=!1;collisionBottom=!1;constructor(t,e=!0){super(),this.restitution=t,this.stationary=e}}var I={};I=new URL("walk_drawn_gun__body-Sheet.6002e4f2.png",import.meta.url).toString();var B={};B=new URL("walk_drawn_gun_legs-Sheet.d820a7b4.png",import.meta.url).toString();var P={};P=new URL("sprint_stowed_gun_body_v2-Sheet.d8fcc020.png",import.meta.url).toString();var O={};O=new URL("sprint_stowed_gun_legs_v2-Sheet.07759801.png",import.meta.url).toString();var F={};F=new URL("stowe_gun_body-Sheet.00c176c4.png",import.meta.url).toString();var U={};U=new URL("draw_gun_body-Sheet.d5fb5e58.png",import.meta.url).toString();var j={};j=new URL("jump_drawn_gun_body_v2-Sheet.8a11f581.png",import.meta.url).toString();var W={};W=new URL("jump_drawn_gun_legs-Sheet.1094a8cf.png",import.meta.url).toString();var q={};q=new URL("ascend_drawn_gun_body.8a9322b7.png",import.meta.url).toString();var N={};N=new URL("ascend_drawn_gun_legs.b3268ac4.png",import.meta.url).toString();var Y={};Y=new URL("stale_stowed_gun_body.c56cbeba.png",import.meta.url).toString();var D={};D=new URL("stale_drawn_gun_body.243306a2.png",import.meta.url).toString();var X={};X=new URL("stale_standing_legs.6bff9712.png",import.meta.url).toString();const G=new Image;G.src=t(I);const K={sprites:9,img:G},J=new Image;J.src=t(B);const $={sprites:10,img:J},Q=new Image;Q.src=t(P);const Z={sprites:8,img:Q},V=new Image;V.src=t(O);const tt={sprites:10,img:V},te=new Image;te.src=t(U);const ts={sprites:15,img:te},ti=new Image;ti.src=t(F);const ta={sprites:15,img:ti},to=new Image;to.src=t(j);const tn={sprites:5,img:to},tr=new Image;tr.src=t(W);const th={sprites:5,img:tr},tl=new Image;tl.src=t(q);const tc={sprites:1,img:tl},tp=new Image;tp.src=t(N);const td={sprites:1,img:tp},tm=new Image;tm.src=t(q);const tu={sprites:1,img:tm},tg=new Image;tg.src=t(N);const tw={sprites:1,img:tg},tf=new Image;tf.src=t(Y);const ty={sprites:1,img:tf},tS=new Image;tS.src=t(D);const tx={sprites:1,img:tS},tb=new Image;tb.src=t(X);const tv={sprites:1,img:tb};class tk extends C{direction="left";actions={walk:{state:"not-in-use",durationMs:0,completeMs:1125},sprint:{state:"not-in-use",durationMs:0,completeMs:1e3},draw:{state:"not-in-use",durationMs:0,completeMs:750},stowe:{state:"not-in-use",durationMs:0,completeMs:750},jump:{state:"not-in-use",durationMs:0,completeMs:600},ascend:{state:"not-in-use",durationMs:0,completeMs:1e3},descend:{state:"not-in-use",durationMs:0,completeMs:1e3},crouch:{state:"not-in-use",durationMs:0,completeMs:1e3}};weapon={state:"drawn"};constructor(t,e={height:140,width:100}){super(t,e,new x(0,0),[new H(1e3),new z(0,!1)])}calculateHitbox(){let t=this.position.x-this.size.width/2*.5;return{x:t,y:this.position.y-this.size.height,width:this.size.width-.5*this.size.width,height:this.size.height}}decideBodySprite(){switch(!0){case"in-use"===this.actions.ascend.state:return{presets:tc,action:this.actions.ascend};case"in-use"===this.actions.descend.state:return{presets:tu,action:this.actions.descend};case"in-use"===this.actions.jump.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.jump.state&&"not-drawn"===this.weapon.state:return{presets:tn,action:this.actions.jump};case"in-use"===this.actions.stowe.state:return{presets:ta,action:this.actions.stowe};case"in-use"===this.actions.draw.state:return{presets:ts,action:this.actions.draw};case"in-use"===this.actions.walk.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.walk.state&&"not-drawn"===this.weapon.state:return{presets:K,action:this.actions.walk};case"in-use"===this.actions.sprint.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.sprint.state&&"not-drawn"===this.weapon.state:return{presets:Z,action:this.actions.sprint};case"drawn"===this.weapon.state:return{presets:tx,action:null};case"not-drawn"===this.weapon.state:default:return{presets:ty,action:null}}}decideLegsSprite(){switch(!0){case"in-use"===this.actions.ascend.state:return{presets:td,action:this.actions.ascend};case"in-use"===this.actions.descend.state:return{presets:tw,action:this.actions.descend};case"in-use"===this.actions.jump.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.jump.state&&"not-drawn"===this.weapon.state:return{presets:th,action:this.actions.jump};case"in-use"===this.actions.walk.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.walk.state&&"not-drawn"===this.weapon.state:return{presets:$,action:this.actions.walk};case"in-use"===this.actions.sprint.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.sprint.state&&"not-drawn"===this.weapon.state:return{presets:tt,action:this.actions.sprint};default:return{presets:tv,action:null}}}draw(t){t.save(),t.imageSmoothingEnabled=!1;let e=1;console.log(this.direction),"right"===this.direction&&(e=-1),"left"===this.direction&&(e=1),t.scale(e,1);let s=this.decideBodySprite(),i=Math.floor((null===s.action?0:s.action.durationMs>s.action.completeMs?s.action.durationMs%s.action.completeMs/s.action.completeMs:s.action.durationMs/s.action.completeMs)*s.presets.sprites);t.drawImage(s.presets.img,20*i,0,20,28,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height);let a=this.decideLegsSprite(),o=Math.floor((null===a.action?0:a.action.durationMs>a.action.completeMs?a.action.durationMs%a.action.completeMs/a.action.completeMs:a.action.durationMs/a.action.completeMs)*a.presets.sprites);t.drawImage(a.presets.img,20*o,0,20,28,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.restore()}}class tT extends C{constructor(t,e){super(t,e),this.addComponents(new z(0))}calculateHitbox(){let t=this.position.x;return{x:t,y:this.position.y,width:this.size.width,height:this.size.height}}draw(t){t.save(),t.fillStyle="black",t.fillRect(this.position.x,this.position.y,this.size.width,this.size.height),t.fillStyle="orange",t.strokeRect(this.position.x,this.position.y,this.size.width,this.size.height),t.stroke(),t.restore()}}class tE{appliesTo(t){return!1}update(t,e,s){throw Error("not implemented")}}class tM extends tE{constructor(){super()}appliesTo(t){return t.hasComponent(z)}update(t,e,s){for(let t of e)t.getComponent(z).collisionLeft=!1,t.getComponent(z).collisionRight=!1,t.getComponent(z).collisionTop=!1,t.getComponent(z).collisionBottom=!1;for(let t of e)for(let s of e){if(t===s||s.getComponent(z).stationary)continue;let e=t.calculateHitbox(),i=s.calculateHitbox(),a=e.x+.5*e.width,o=e.y+.5*e.height,n=i.x+.5*i.width,r=i.y+.5*i.height,h=n-a,l=r-o,c=(i.width+e.width)*.5,p=(i.height+e.height)*.5;if(!(Math.abs(h)>c||Math.abs(l)>p)){if(Math.abs(h/e.width)>Math.abs(l/e.height)){if(h<0){console.log("left");let a=e.x-i.x-i.width;s.position.x+=a,t.getComponent(z).collisionLeft=!0,s.getComponent(z).collisionRight=!0}else{console.log("right");let a=e.x-i.x+e.width;s.position.x+=a,t.getComponent(z).collisionRight=!0,s.getComponent(z).collisionLeft=!0}}else if(l<0){console.log("top");let a=e.y-i.height-i.y;s.position.y+=a,t.getComponent(z).collisionTop=!0,s.getComponent(z).collisionBottom=!0,s.vector.y=0}else{let a=e.y+e.height-i.y;console.log("bottom"),s.position.y+=a,t.getComponent(z).collisionBottom=!0,s.getComponent(z).collisionTop=!0}}}}}class t_ extends tE{constructor(){super()}appliesTo(t){return t.hasComponent(H)}update(t,e,s){for(let t of e){let e=t.getComponent(H).pull;t.vector.y+=e*s}}}class tL extends tE{constructor(){super()}appliesTo(t){return!0}update(t,e,s){for(let t of e){let e=t.vector;t.position.x+=e.x*s,t.position.y+=e.y*s}}}class tA{input=new Set;constructor(){document.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":return this.input.add("up");case"ArrowLeft":return this.input.add("left");case"ArrowDown":return this.input.add("down");case"ArrowRight":return this.input.add("right");case"s":return this.input.add("S")}}),document.addEventListener("keyup",t=>{switch(t.key){case"ArrowUp":return this.input.delete("up");case"ArrowLeft":return this.input.delete("left");case"ArrowDown":return this.input.delete("down");case"ArrowRight":return this.input.delete("right");case"s":return this.input.delete("S")}})}getActions(t){return this.determineActions(this.input,t)}determineActions(t,e){let s=new Set;for(let i of t)switch(i){case"left":["jump"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&s.add("sprint-left"),"drawn"===e.weapon.state&&s.add("walk-left"),s.delete("walk-right"),s.delete("sprint-right"));break;case"right":["jump"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&s.add("sprint-right"),"drawn"===e.weapon.state&&s.add("walk-right"),s.delete("walk-left"),s.delete("sprint-left"));break;case"down":break;case"up":["jump","ascend","descend","stowe","draw"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&s.add("draw-weapon"),"drawn"===e.weapon.state&&s.add("stowe-weapon"));break;case"S":["jump","ascend","descend","stowe","draw"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&s.add("leap"),"drawn"===e.weapon.state&&s.add("jump"))}return s}}class tC extends tE{inputHandler=new tA;constructor(){super()}appliesTo(t){return t instanceof tk}update(t,e,s){for(let t of e){if(!(t instanceof tk))throw Error("#update called with non Player instance");this.updateActionTimers(t,s);let e=this.inputHandler.getActions(t),i=["walk-left","walk-right"],a=["sprint-left","sprint-right"];![...i,...a].some(t=>e.has(t))&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.vector.x=0),i.some(t=>e.has(t))||(t.actions.walk.state="not-in-use",t.actions.walk.durationMs=0),a.some(t=>e.has(t))||(t.actions.sprint.state="not-in-use",t.actions.sprint.durationMs=0),e.has("crouch")||(t.actions.crouch.state="not-in-use",t.actions.crouch.durationMs=0),t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.actions.ascend.state="not-in-use",t.actions.ascend.durationMs=0,t.actions.descend.state="not-in-use",t.actions.descend.durationMs=0),"complete"===t.actions.jump.state&&(t.vector.y=-600,t.actions.ascend.state="in-use","left"===t.direction&&(t.vector.x=-200),"right"===t.direction&&(t.vector.x=200)),"complete"===t.actions.draw.state&&(t.weapon.state="drawn"),t.hasComponent(z)&&!t.getComponent(z).collisionBottom&&t.vector.y>0&&(t.actions.descend.state="in-use"),e.has("walk-left")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.direction="left",t.vector.x=-250,t.actions.walk.state="in-use"),e.has("sprint-left")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.direction="left",t.vector.x=-500,t.actions.sprint.state="in-use"),e.has("walk-right")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.direction="right",t.vector.x=250,t.actions.walk.state="in-use"),e.has("sprint-right")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.direction="right",t.vector.x=500,t.actions.sprint.state="in-use"),e.has("jump")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.actions.jump.state="in-use"),e.has("leap")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.actions.jump.state="in-use"),e.has("draw-weapon")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.actions.draw.state="in-use"),e.has("stowe-weapon")&&t.hasComponent(z)&&t.getComponent(z).collisionBottom&&(t.actions.stowe.state="in-use",t.weapon.state="not-drawn"),this.resetCompletedActions(t)}}updateActionTimers(t,e){"in-use"===t.actions.walk.state&&(t.actions.walk.durationMs+=1e3*e),"in-use"===t.actions.sprint.state&&(t.actions.sprint.durationMs+=1e3*e),"in-use"===t.actions.draw.state&&(t.actions.draw.durationMs+=1e3*e),"in-use"===t.actions.stowe.state&&(t.actions.stowe.durationMs+=1e3*e),"in-use"===t.actions.jump.state&&(t.actions.jump.durationMs+=1e3*e),"in-use"===t.actions.crouch.state&&(t.actions.crouch.durationMs+=1e3*e),"in-use"===t.actions.ascend.state&&(t.actions.ascend.durationMs+=1e3*e),"in-use"===t.actions.descend.state&&(t.actions.descend.durationMs+=1e3*e),t.actions.draw.durationMs>=t.actions.draw.completeMs&&(t.actions.draw.state="complete"),t.actions.stowe.durationMs>=t.actions.stowe.completeMs&&(t.actions.stowe.state="complete"),t.actions.jump.durationMs>=t.actions.jump.completeMs&&(t.actions.jump.state="complete"),t.actions.crouch.durationMs>=t.actions.crouch.completeMs&&(t.actions.crouch.state="complete")}resetCompletedActions(t){"complete"===t.actions.walk.state&&(t.actions.walk.state="not-in-use",t.actions.walk.durationMs=0),"complete"===t.actions.sprint.state&&(t.actions.sprint.state="not-in-use",t.actions.sprint.durationMs=0),"complete"===t.actions.draw.state&&(t.actions.draw.state="not-in-use",t.actions.draw.durationMs=0),"complete"===t.actions.stowe.state&&(t.actions.stowe.state="not-in-use",t.actions.stowe.durationMs=0),"complete"===t.actions.jump.state&&(t.actions.jump.state="not-in-use",t.actions.jump.durationMs=0),"complete"===t.actions.crouch.state&&(t.actions.crouch.state="not-in-use",t.actions.crouch.durationMs=0),"complete"===t.actions.ascend.state&&(t.actions.ascend.state="not-in-use",t.actions.ascend.durationMs=0),"complete"===t.actions.descend.state&&(t.actions.descend.state="not-in-use",t.actions.descend.durationMs=0)}}class tR{game;entities=[];player;gravitySystem=new t_;collisionSystem=new tM;moveSystem=new tL;playerSystem=new tC;constructor(t){this.game=t,this.player=new tk({x:t.gameWidth/2,y:t.gameHeight/2});let e={height:t.gameHeight,width:t.gameWidth,entities:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,99,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]};this.setupLevel(e)}setupLevel(t){let e={start:null,width:0,height:0};for(let s=0;s<t.entities.length;s++)for(let i=0;i<t.entities[s].length;i++){let a={width:t.width/t.entities[s].length,height:t.height/t.entities.length},o={x:a.width*i,y:a.height*s};if(0!==t.entities[s][i]&&(99===t.entities[s][i]&&(this.player=new tk({x:a.width*i,y:a.height*s})),1===t.entities[s][i])){if(null===e.start&&(e.start={x:o.x,y:o.y}),t.entities[s+1]&&1===t.entities[s+1][i]){let o=!1;for(let n=0;n<t.entities.length-s;n++)if(t.entities[s+n+1]&&1===t.entities[s+n+1][i])1===t.entities[s+n][i]?(e.width=a.width,e.height+=a.height,t.entities[s+n][i]=0):console.error("AKJSDKJASNDKJN");else{e.width=a.width,e.height+=a.height,t.entities[s+n][i]=0,this.entities.push(new tT(e.start,{width:e.width,height:e.height})),e={start:null,width:0,height:0},o=!0;break}if(o)continue}else if(1===t.entities[s][i+1]){e.width+=a.width,e.height=a.height,t.entities[s][i]=0;continue}else{e.width+=a.width,e.height=a.height,t.entities[s][i]=0,this.entities.push(new tT(e.start,{width:e.width,height:e.height})),e={start:null,width:0,height:0};continue}}}}update(t){for(let e of[this.playerSystem,this.gravitySystem,this.moveSystem,this.collisionSystem]){let s=[this.player,...this.entities].filter(e.appliesTo);e.update(this.game,s,t)}}draw(t){if(null!==this.player)for(let e of[...this.entities,this.player])e.draw(t)}}o=class{gameWidth;gameHeight;mainCtx;mousePos;players=[{name:"mami",lvl:1,stats:{maxHp:60,maxStamina:60,strength:1,intelligence:1,dodgeChance:.1,hitRate:.9}},{name:"papi",lvl:1,stats:{maxHp:60,maxStamina:60,strength:1,intelligence:1,dodgeChance:.1,hitRate:.9}}];mapScreen=new v(this);pauseScreen=new _(this);battleSystem=new A(this);marioSystem;input=new Set;state="RUNNING";constructor(t,e,s,i={x:t/2,y:e/2}){this.gameWidth=t,this.gameHeight=e,this.mainCtx=s,this.mousePos=i;let a=k("gameScreen");this.marioSystem=new tR(this),a.addEventListener("click",()=>{this.input.add("leftClick")}),this.start()}start(){}update(t){this.marioSystem.update(t)}clearInput(){this.input.clear()}draw(t){this.marioSystem.draw(t)}};const tH=document.querySelector("#gameScreen"),tz=tH.getContext("2d");tz.imageSmoothingEnabled=!0,tz.imageSmoothingQuality="high",tH.width=800,tH.height=600;const tI=new o(800,600,tz);let tB=0;requestAnimationFrame(function t(e){let s=(e-tB)/1e3;tB=e,tz.clearRect(0,0,800,600),tI.update(s),tI.draw(tz),requestAnimationFrame(t)});
function t(t){return t&&t.__esModule?t.default:t}var e,i,s,a,o,n={};n=new URL("stockholm_map.2976de6e.png",import.meta.url).toString();const r=(t,e)=>{let i=Math.ceil(t);return Math.floor(Math.random()*(Math.floor(e)-i+1)+i)},h=t=>{for(let e=t.length-1;e>0;e--){let i=Math.floor(Math.random()*(e+1)),s=t[e];t[e]=t[i],t[i]=s}return t};i=class{position;size;rotation;constructor(t,e,i=0){this.position=t,this.size=e,this.rotation=i}distanceTo(t){return Math.sqrt(Math.pow(this.position.x-t.x,2)+Math.pow(this.position.y-t.y,2))}draw(t,e,i,s){throw Error("#draw not implemented yet!")}},s=class{constructor(){}};class l extends s{x;y;constructor(t,e){super(),this.x=t,this.y=e}magnitude(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}dot(t){return this.x*t.x+this.y*t.y}norm(){return{x:this.x/this.magnitude(),y:this.y/this.magnitude()}}normalize(){let t=this.norm();return new l(t.x,t.y)}}const c={archeologist:{type:"archeologist",skills:[{name:"Hit",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=1,fixedBonus:e=0})=>({type:"damage",points:10*t+e}),unlockLvl:1},{name:"Throw Dirt",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"blind",duration:2}),unlockLvl:1},{name:"Examine",validTarget:["enemy"],numberOfTargets:-1,generateSkillEffect:()=>({type:"weaken",duration:1}),unlockLvl:2},{name:"Dig",validTarget:["allies"],numberOfTargets:1,generateSkillEffect:()=>({type:"evade",duration:2}),unlockLvl:3}]},medic:{type:"medic",skills:[{name:"Stitch",validTarget:["allies","self"],numberOfTargets:1,generateSkillEffect:()=>({type:"heal",points:15}),unlockLvl:1},{name:"Cut",validTarget:["enemy"],numberOfTargets:2,generateSkillEffect:({multiplier:t=1,fixedBonus:e=0})=>({type:"damage",points:15*t+e}),unlockLvl:1},{name:"Drain Blood",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"bleed",points:10,duration:3}),unlockLvl:2},{name:"Restrain",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:()=>({type:"snare",duration:1}),unlockLvl:3},{name:"Drug",validTarget:["enemy"],numberOfTargets:2,generateSkillEffect:()=>({type:"confuse",duration:1}),unlockLvl:4}]},zombie:{type:"zombie",skills:[{name:"Scratch",validTarget:["enemy"],numberOfTargets:1,generateSkillEffect:({multiplier:t=1,fixedBonus:e=0})=>({type:"damage",points:15*t+e}),unlockLvl:1}]}};var p={};p=new URL("zombie_spritesheet.cc0599cc.png",import.meta.url).toString();class d extends i{lvl;size={height:100,width:100};name="Zombie";role=c.zombie;atkBar=0;stats;effects=[];spritesheet=new Image;originalPosition;vector=new l(0,0);actions={stale:{state:"in-use",durationMs:0,completeMs:1125},walk:{state:"not-in-use",durationMs:0,completeMs:1125},hit:{state:"not-in-use",durationMs:0,completeMs:750}};constructor(e,i,s=0,a={height:50,width:50}){super(i,a,s),this.lvl=e,this.spritesheet.src=t(p);let o=this.generateStatsFromLvl(e);this.originalPosition={x:i.x,y:i.y},this.stats=o}generateStatsFromLvl(t){return{hp:40*t,maxHp:40*t,stamina:40*t,maxStamina:40*t,strength:1*t,intelligence:1*t,hitRate:1-.4*t,dodgeChance:1-.9*t,speed:1*t}}calculateHitbox(){let t=this.position.x-this.size.width/2*1;return{x:t,y:this.position.y-this.size.height,width:this.size.width-0*this.size.width,height:this.size.height}}draw({ctx:t,offsetX:e=0,offsetY:i=0},s,a=!1,o=!1){t.save(),t.translate(e,i);let n=this.calculateHitbox();if(t.fillStyle="grey",t.fillRect(n.x,n.y-30,n.width,10),t.fillStyle="red",t.fillRect(n.x,n.y-30,n.width*(this.stats.hp/this.stats.maxHp),10),t.fillStyle="grey",t.fillRect(n.x,n.y-20,n.width,10),t.fillStyle="blue",t.fillRect(n.x,n.y-20,n.width*(this.stats.stamina/this.stats.maxStamina),10),t.fillStyle="grey",t.fillRect(n.x,n.y-10,n.width,10),t.fillStyle="green",t.fillRect(n.x,n.y-10,n.width*(this.atkBar/1),10),t.lineWidth=2,t.strokeStyle="yellow",t.strokeRect(n.x,n.y-30,n.width,10),t.strokeStyle="yellow",t.strokeRect(n.x,n.y-20,n.width,10),t.strokeStyle="yellow",t.strokeRect(n.x,n.y-10,n.width,10),t.imageSmoothingEnabled=!1,a){t.shadowColor="green",t.shadowBlur=0;let e=[-4,4];for(let i=0;i<e.length;i++){t.shadowOffsetX=e[i];for(let i=0;i<e.length;i++)t.shadowOffsetY=e[i],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}if(o){t.shadowColor="yellow",t.shadowBlur=0;let e=[-2,2];for(let i=0;i<e.length;i++){t.shadowOffsetX=e[i];for(let i=0;i<e.length;i++)t.shadowOffsetY=e[i],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore(),"in-use"===this.actions.stale.state&&(this.actions.stale.durationMs+=1e3*s),"in-use"===this.actions.walk.state&&(this.actions.walk.durationMs+=1e3*s),"in-use"===this.actions.hit.state&&(this.actions.hit.durationMs+=1e3*s),this.actions.hit.durationMs>=this.actions.hit.completeMs&&(this.actions.hit.state="complete")}}var u={};u=new URL("mami_spritesheet.b49e3f9a.png",import.meta.url).toString();class m extends i{lvl;stats;name="Mami";role=c.medic;atkBar=0;effects=[];spritesheet=new Image;originalPosition;vector=new l(0,0);actions={stale:{state:"in-use",durationMs:0,completeMs:1125},walk:{state:"not-in-use",durationMs:0,completeMs:1125},hit:{state:"not-in-use",durationMs:0,completeMs:750}};constructor(e,i,s,a=0,o={height:96,width:96}){super(s,o,a),this.lvl=e,this.stats=i,this.originalPosition={x:s.x,y:s.y},this.spritesheet.src=t(u)}calculateHitbox(){let t=this.position.x-this.size.width/2*1;return{x:t,y:this.position.y-this.size.height,width:this.size.width-0*this.size.width,height:this.size.height}}draw({ctx:t,offsetX:e=0,offsetY:i=0},s,a=!1,o=!1){t.save(),t.translate(e,i);let n=this.calculateHitbox();if(t.fillStyle="grey",t.fillRect(n.x,n.y-30,n.width,10),t.fillStyle="red",t.fillRect(n.x,n.y-30,n.width*(this.stats.hp/this.stats.maxHp),10),t.fillStyle="grey",t.fillRect(n.x,n.y-20,n.width,10),t.fillStyle="blue",t.fillRect(n.x,n.y-20,n.width*(this.stats.stamina/this.stats.maxStamina),10),t.fillStyle="grey",t.fillRect(n.x,n.y-10,n.width,10),t.fillStyle="green",t.fillRect(n.x,n.y-10,n.width*(this.atkBar/1),10),t.lineWidth=2,t.strokeStyle="yellow",t.strokeRect(n.x,n.y-30,n.width,10),t.strokeStyle="yellow",t.strokeRect(n.x,n.y-20,n.width,10),t.strokeStyle="yellow",t.strokeRect(n.x,n.y-10,n.width,10),t.imageSmoothingEnabled=!1,a){t.shadowColor="green",t.shadowBlur=0;let e=[-2,2];for(let i=0;i<e.length;i++){t.shadowOffsetX=e[i];for(let i=0;i<e.length;i++)t.shadowOffsetY=e[i],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}if(o){t.shadowColor="yellow",t.shadowBlur=0;let e=[-4,4];for(let i=0;i<e.length;i++){t.shadowOffsetX=e[i];for(let i=0;i<e.length;i++)t.shadowOffsetY=e[i],t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.drawImage(this.spritesheet,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore(),"in-use"===this.actions.stale.state&&(this.actions.stale.durationMs+=1e3*s),"in-use"===this.actions.walk.state&&(this.actions.walk.durationMs+=1e3*s),"in-use"===this.actions.hit.state&&(this.actions.hit.durationMs+=1e3*s),this.actions.hit.durationMs>=this.actions.hit.completeMs&&(this.actions.hit.state="complete")}}var g={};g=new URL("walk_drawn_gun__body-Sheet.6002e4f2.png",import.meta.url).toString();var w={};w=new URL("walk_drawn_gun_legs-Sheet.d820a7b4.png",import.meta.url).toString();var f={};f=new URL("sprint_stowed_gun_body_v2-Sheet.d8fcc020.png",import.meta.url).toString();var y={};y=new URL("sprint_stowed_gun_legs_v2-Sheet.07759801.png",import.meta.url).toString();var x={};x=new URL("stowe_gun_body-Sheet.00c176c4.png",import.meta.url).toString();var S={};S=new URL("draw_gun_body-Sheet.d5fb5e58.png",import.meta.url).toString();var M={};M=new URL("jump_drawn_gun_body_v2-Sheet.8a11f581.png",import.meta.url).toString();var b={};b=new URL("jump_drawn_gun_legs-Sheet.1094a8cf.png",import.meta.url).toString();var k={};k=new URL("leap_stowed_gun_body-Sheet.7a171eba.png",import.meta.url).toString();var v={};v=new URL("leap_stowed_gun_legs-Sheet.d5b2d32e.png",import.meta.url).toString();var T={};T=new URL("ascend_drawn_gun_body.8a9322b7.png",import.meta.url).toString();var _={};_=new URL("ascend_drawn_gun_legs.b3268ac4.png",import.meta.url).toString();var A={};A=new URL("stale_stowed_gun_body.c56cbeba.png",import.meta.url).toString();var E={};E=new URL("stale_drawn_gun_body.243306a2.png",import.meta.url).toString();var C={};C=new URL("stale_standing_legs.6bff9712.png",import.meta.url).toString();var R={};R=new URL("butt-attack-drawn-gun-whole-body-Sheet.d4b28379.png",import.meta.url).toString();var z={};z=new URL("butt-attack-drawn-gun-stale-whole-body.369091bc.png",import.meta.url).toString();const I=new Image;I.src=t(g);const L={sprites:9,img:I},H=new Image;H.src=t(w);const B={sprites:10,img:H},P=new Image;P.src=t(f);const O={sprites:8,img:P},F=new Image;F.src=t(y);const U={sprites:10,img:F},j=new Image;j.src=t(S);const W={sprites:15,img:j},D=new Image;D.src=t(x);const Y={sprites:15,img:D},q=new Image;q.src=t(M);const G={sprites:5,img:q},N=new Image;N.src=t(b);const X={sprites:5,img:N},K=new Image;K.src=t(k);const $={sprites:5,img:K},V=new Image;V.src=t(v);const Q={sprites:7,img:V},Z=new Image;Z.src=t(T);const J={sprites:1,img:Z},tt=new Image;tt.src=t(_);const te={sprites:1,img:tt},ti=new Image;ti.src=t(T);const ts={sprites:1,img:ti},ta=new Image;ta.src=t(_);const to={sprites:1,img:ta},tn=new Image;tn.src=t(A);const tr={sprites:1,img:tn},th=new Image;th.src=t(E);const tl={sprites:1,img:th},tc=new Image;tc.src=t(C);const tp={sprites:1,img:tc},td=new Image;td.src=t(R);const tu={sprites:7,img:td},tm=new Image;tm.src=t(z);const tg={sprites:1,img:tm};class tw extends i{lvl;stats;name="Papi";role=c.archeologist;atkBar=0;effects=[];spritesheet=new Image;originalPosition;vector=new l(0,0);actions={stale:{state:"in-use",durationMs:0,completeMs:1125},walk:{state:"not-in-use",durationMs:0,completeMs:1125},hit:{state:"not-in-use",durationMs:0,completeMs:750}};constructor(t,e,i,s=0,a={height:112,width:80}){super(i,a,s),this.lvl=t,this.stats=e,this.originalPosition={x:i.x,y:i.y}}calculateHitbox(){let t=this.position.x-this.size.width/2*1;return{x:t,y:this.position.y-this.size.height,width:this.size.width-0*this.size.width,height:this.size.height}}decideBodySprite(){switch(!0){case"in-use"===this.actions.walk.state:return{presets:L,action:this.actions.walk};case"in-use"===this.actions.hit.state:return{presets:W,action:this.actions.hit};default:return{presets:tr,action:this.actions.stale}}}decideLegsSprite(){switch(!0){case"in-use"===this.actions.walk.state:return{presets:B,action:this.actions.walk};case"in-use"===this.actions.hit.state:return{presets:tp,action:this.actions.hit};default:return{presets:tp,action:this.actions.stale}}}draw({ctx:t,offsetX:e=0,offsetY:i=0},s,a=!1,o=!1){t.save(),t.translate(e,i);let n=this.calculateHitbox();t.fillStyle="grey",t.fillRect(n.x,n.y-30,n.width,10),t.fillStyle="red",t.fillRect(n.x,n.y-30,n.width*(this.stats.hp/this.stats.maxHp),10),t.fillStyle="grey",t.fillRect(n.x,n.y-20,n.width,10),t.fillStyle="blue",t.fillRect(n.x,n.y-20,n.width*(this.stats.stamina/this.stats.maxStamina),10),t.fillStyle="grey",t.fillRect(n.x,n.y-10,n.width,10),t.fillStyle="green",t.fillRect(n.x,n.y-10,n.width*(this.atkBar/1),10),t.lineWidth=2,t.strokeStyle="yellow",t.strokeRect(n.x,n.y-30,n.width,10),t.strokeStyle="yellow",t.strokeRect(n.x,n.y-20,n.width,10),t.strokeStyle="yellow",t.strokeRect(n.x,n.y-10,n.width,10),t.imageSmoothingEnabled=!1,t.scale(1,1);let r=this.decideLegsSprite(),h=Math.floor((null===r.action?0:r.action.durationMs>r.action.completeMs?r.action.durationMs%r.action.completeMs/r.action.completeMs:r.action.durationMs/r.action.completeMs)*r.presets.sprites),l=this.decideBodySprite(),c=Math.floor((null===l.action?0:l.action.durationMs>l.action.completeMs?l.action.durationMs%l.action.completeMs/l.action.completeMs:l.action.durationMs/l.action.completeMs)*l.presets.sprites);if(a){t.shadowColor="green",t.shadowBlur=0;let e=[-2,2];for(let i=0;i<e.length;i++){t.shadowOffsetX=e[i];for(let i=0;i<e.length;i++)t.shadowOffsetY=e[i],t.drawImage(r.presets.img,20*h,0,20,28,1*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.drawImage(l.presets.img,20*c,0,20,28,1*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}if(o){t.shadowColor="yellow",t.shadowBlur=0;let e=[-4,4];for(let i=0;i<e.length;i++){t.shadowOffsetX=e[i];for(let i=0;i<e.length;i++)t.shadowOffsetY=e[i],t.drawImage(r.presets.img,20*h,0,20,28,1*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.drawImage(l.presets.img,20*c,0,20,28,1*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}}t.shadowOffsetX=0,t.shadowOffsetY=0,t.drawImage(r.presets.img,20*h,0,20,28,1*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.drawImage(l.presets.img,20*c,0,20,28,1*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.resetTransform(),t.restore(),"in-use"===this.actions.stale.state&&(this.actions.stale.durationMs+=1e3*s),"in-use"===this.actions.walk.state&&(this.actions.walk.durationMs+=1e3*s),"in-use"===this.actions.hit.state&&(this.actions.hit.durationMs+=1e3*s),this.actions.hit.durationMs>=this.actions.hit.completeMs&&(this.actions.hit.state="complete")}}class tf{background;foes;players;constructor(t,e,i){this.background=i,this.foes=this.generateFoes(t,e.foes),this.players=this.generatePlayers(t,e.players)}generateFoes(t,e){let i=r(e.min,e.max),s=[];for(let t=0;t<i;t++){let t=Math.floor(Math.random()*e.types.length),i=e.types[t];if(!i)continue;let a=r(i.lvl.min,i.lvl.max);s.push({type:i.type,lvl:a})}let a=t.gameHeight/3,o=s.length%3==0?3:s.length%3;return s.map((t,e)=>{let i=Math.floor(e/3)+1,n=Math.ceil(s.length/3)===i?o:3,r=a/n;switch(t.type){case"zombie":case"brute":return new d(t.lvl,{x:40+70*i-e%3*(60/n),y:e%3*r+r/2+2*a})}})}generatePlayers(t,e){let i=t.gameHeight/3,s=e.length%3==0?3:e.length%3;return e.map((a,o)=>{let n=Math.floor(o/3)+1,r=Math.ceil(e.length/3)===n?s:3,h=i/r,l=o%3*h+h/2+2*i,c=t.gameWidth-70*n-o%3*(60/r);switch(a.name){case"mami":return new m(a.lvl,a.stats,{x:c,y:l});case"papi":return new tw(a.lvl,a.stats,{x:c,y:l})}})}drawBackground({game:t,ctx:e,offsetX:i=0,offsetY:s=0}){let a=Math.min(t.gameWidth/this.background.width,t.gameHeight/this.background.height),o=(t.gameWidth-this.background.width*a)/2,n=(t.gameHeight-this.background.height*a)/2;e.translate(i,s),e.drawImage(this.background,0,0,this.background.width,this.background.height,o,n,this.background.width*a,this.background.height*a),e.resetTransform()}}var ty={};ty=new URL("ahlens_map.e96a496f.png",import.meta.url).toString();class tx extends tf{constructor(e,i){let s=new Image;s.src=t(ty),super(e,{players:i,foes:{min:3,max:4,types:[{type:"zombie",lvl:{min:1,max:2}},{type:"brute",lvl:{min:1,max:2}}]}},s)}}const tS={height:1e3,width:7e3,entities:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,99,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,98,98,98,97,98,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]};(e=a||(a={}))[e.BATTLE=0]="BATTLE",e[e.MARIO=1]="MARIO";class tM{texture;stops=[{type:a.BATTLE,setupBattle:t=>new tx(t.game,t.players),x:577,y:206},{type:a.MARIO,levelSetup:tS,x:548,y:252},{type:a.BATTLE,setupBattle:t=>new tx(t.game,t.players),x:467,y:310},{type:a.BATTLE,setupBattle:t=>new tx(t.game,t.players),x:493,y:376},{type:a.BATTLE,setupBattle:t=>new tx(t.game,t.players),x:335,y:384},{type:a.BATTLE,setupBattle:t=>new tx(t.game,t.players),x:362,y:460},{type:a.BATTLE,setupBattle:t=>new tx(t.game,t.players),x:430,y:452}];currentStop=this.stops[0];player={originPos:{x:this.stops[0].x,y:this.stops[0].y},queue:[]};constructor(){let e=new Image;e.src=t(n),this.texture=e}}var tb={};tb=new URL("player.8afcec90.png",import.meta.url).toString();const tk=["up","left","down","right","enter"];class tv{game;map=new tM;playerTexture;constructor(e){this.game=e;let i=new Image;i.src=t(tb),this.playerTexture=i}update(t){if(tk.some(t=>this.game.input.has(t))&&this.game.input.forEach(t=>{let e=this.map.stops.indexOf(this.map.currentStop),i=this.map.stops.length-1===e?null:{stop:this.map.stops[e+1],vectorTo:new l(this.map.stops[e+1].x-this.map.currentStop.x,this.map.stops[e+1].y-this.map.currentStop.y)},s=0===e?null:{stop:this.map.stops[e-1],vectorTo:new l(this.map.stops[e-1].x-this.map.currentStop.x,this.map.stops[e-1].y-this.map.currentStop.y)};switch(t){case"up":(i&&i.vectorTo.y<0||s&&s.vectorTo.y<0)&&(i&&s?i.vectorTo.norm().y<s.vectorTo.norm().y?this.map.currentStop=i.stop:this.map.currentStop=s.stop:i?this.map.currentStop=i.stop:s&&(this.map.currentStop=s.stop));break;case"down":(i&&i.vectorTo.y>0||s&&s.vectorTo.y>0)&&(i&&s?i.vectorTo.norm().y>s.vectorTo.norm().y?this.map.currentStop=i.stop:this.map.currentStop=s.stop:i?this.map.currentStop=i.stop:s&&(this.map.currentStop=s.stop));break;case"left":(i&&i.vectorTo.x<0||s&&s.vectorTo.x<0)&&(i&&s?i.vectorTo.norm().x<s.vectorTo.norm().x?this.map.currentStop=i.stop:this.map.currentStop=s.stop:i?this.map.currentStop=i.stop:s&&(this.map.currentStop=s.stop));break;case"right":(i&&i.vectorTo.x>0||s&&s.vectorTo.x>0)&&(i&&s?i.vectorTo.norm().x>s.vectorTo.norm().x?this.map.currentStop=i.stop:this.map.currentStop=s.stop:i?this.map.currentStop=i.stop:s&&(this.map.currentStop=s.stop));break;case"enter":switch(this.map.currentStop.type){case a.BATTLE:{let t=this.map.currentStop.setupBattle({game:this.game,players:this.game.players});this.game.battleSystem.battle.active=t,this.game.state="BATTLE_SCENE";break}case a.MARIO:this.game.marioSystem.setupLevel(this.map.currentStop.levelSetup),this.game.state="MARIO_GAME"}}let o=this.map.player.queue.indexOf(this.map.currentStop);o>=0?this.map.player.queue=this.map.player.queue.slice(0,o+1):(this.map.currentStop.x!==this.map.player.originPos.x||this.map.currentStop.y!==this.map.player.originPos.y)&&this.map.player.queue.push(this.map.currentStop)}),0!==this.map.player.queue.length){let e=new l(this.map.player.queue[0].x-this.map.player.originPos.x,this.map.player.queue[0].y-this.map.player.originPos.y),i=e.norm(),s=new l(170*i.x*t,170*i.y*t);s.magnitude()>e.magnitude()?(this.map.player.originPos.x=this.map.player.queue[0].x,this.map.player.originPos.y=this.map.player.queue[0].y,this.map.player.queue.shift()):(this.map.player.originPos.x+=s.x,this.map.player.originPos.y+=s.y)}}draw(t){let e=Math.min(this.game.gameWidth/this.map.texture.width,this.game.gameHeight/this.map.texture.height),i=(this.game.gameWidth-this.map.texture.width*e)/2,s=(this.game.gameHeight-this.map.texture.height*e)/2;t.clearRect(0,0,this.game.gameWidth,this.game.gameHeight),t.drawImage(this.map.texture,0,0,this.map.texture.width,this.map.texture.height,i,s,this.map.texture.width*e,this.map.texture.height*e);for(let e=0;e<this.map.stops.length;e++)this.map.stops[e+1]&&(t.save(),t.beginPath(),t.setLineDash([5,3]),t.moveTo(this.map.stops[e].x+i,this.map.stops[e].y+s),t.lineTo(this.map.stops[e+1].x+i,this.map.stops[e+1].y+s),t.lineWidth=3,t.stroke(),t.restore()),t.save(),t.fillStyle=this.map.currentStop===this.map.stops[e]?"red":"orange",t.beginPath(),t.arc(this.map.stops[e].x+i,this.map.stops[e].y+s,5,0,2*Math.PI),t.fill(),t.restore();t.drawImage(this.playerTexture,this.map.player.originPos.x+i-17.5,this.map.player.originPos.y+s-40,35,35)}}const tT=t=>{let e=document.getElementById(t);if(null===e)throw Error(`Could not find element with id ${t}`);return e},t_=tT("pauseScreen"),tA=tT("options"),tE=["up","left","down","right","enter"];class tC{game;options=[{id:"continue",text:"Continue"},{id:"map",text:"Map"},{id:"settings",text:"Settings"},{id:"credits",text:"Credits"}];selectedOption="continue";constructor(t){this.game=t;let e=tT("options");for(let t of this.options){let i=document.createElement("span");t.id===this.selectedOption&&i.setAttribute("data-selected","selected"),i.setAttribute("data-optionId",t.id),i.textContent=t.text,i.addEventListener("mouseenter",()=>{this.handleSwitchSelectedOption(()=>t)}),i.addEventListener("click",()=>{this.handleSubmitOption()}),e.appendChild(i)}}show(){t_.style.display="flex"}hide(){t_.style.display="none"}handleSwitchSelectedOption(t){let e=tA.querySelector("[data-selected='selected']");if(e){e.removeAttribute("data-selected");let i=e.getAttribute("data-optionId"),s=this.options.findIndex(t=>t.id===i),a=t(-1===s?null:s),o=tA.querySelector(`[data-optionId='${a.id}']`);o&&(this.selectedOption=a.id,o.setAttribute("data-selected","selected"))}}handleSubmitOption(){switch(this.selectedOption){case"continue":this.hide(),this.game.paused=!1;break;case"map":this.hide(),this.game.paused=!1,this.game.state="MAP_SCREEN"}}update(){tE.some(t=>this.game.input.has(t))&&this.game.input.forEach(t=>{switch(t){case"up":this.handleSwitchSelectedOption(t=>0===t||null===t?this.options[this.options.length-1]:this.options[t-1]);break;case"down":this.handleSwitchSelectedOption(t=>t===this.options.length-1||null===t?this.options[0]:this.options[t+1]);break;case"enter":this.handleSubmitOption()}})}}const tR=["up","left","down","right","enter"];class tz{game;battle={active:null,queue:[]};state={name:"SLEEP"};animations=[{type:"commence-battle",durationMs:1200,timePassedMs:0}];constructor(t){this.game=t}update(t){if(this.battle.active){switch(this.updateAnimations(t).deleted.some(t=>"commence-battle"===t.type)&&(this.state={name:"PROGRESS_ATB"}),this.state.name){case"SLEEP":break;case"PROGRESS_ATB":{let e=null;for(let i of[...this.battle.active.foes,...this.battle.active.players])i.atkBar=i.atkBar+i.stats.speed*t,i.atkBar>=1&&(i.atkBar=1),null===e&&1===i.atkBar&&(e=i);null!==e&&this.battle.active.players.find(t=>t===e)&&(this.state={name:"PLAYER_SELECT_SKILL",characterTurn:e,focusedSkill:e.role.skills[0]}),null!==e&&this.battle.active.foes.find(t=>t===e)&&(this.state={name:"CALCULATE_FOE_ACTION",characterTurn:e});break}case"ANIMATING_ACTION":{let e=t=>"Foe"==("Mami"===t.name||"Papi"===t.name?"Player":"Foe")?-125:125;if(null===this.state.characterDestination&&(this.state.characterDestination={x:this.state.selectedTargets[0].position.x+e(this.state.characterTurn),y:this.state.selectedTargets[0].position.y}),this.state.characterTurn.position.x+=this.state.characterTurn.vector.x*t,this.state.characterTurn.position.y+=this.state.characterTurn.vector.y*t,this.state.characterTurn.vector.magnitude()*t>=this.state.characterTurn.distanceTo(this.state.characterDestination)&&(this.state.characterTurn.position.x=this.state.characterDestination.x,this.state.characterTurn.position.y=this.state.characterDestination.y,this.state.characterTurn.vector.x=0,this.state.characterTurn.vector.y=0,this.state.characterTurn.actions.walk.state="not-in-use"),this.state.characterTurn.position.x===this.state.characterTurn.originalPosition.x&&this.state.characterTurn.position.y===this.state.characterTurn.originalPosition.y&&this.state.characterDestination.x!==this.state.characterTurn.originalPosition.x&&this.state.characterDestination.y!==this.state.characterTurn.originalPosition.y){let t=new l(this.state.characterDestination.x-this.state.characterTurn.position.x,this.state.characterDestination.y-this.state.characterTurn.position.y);t.x/=1.5,t.y/=1.5,this.state.characterTurn.vector.x=t.x,this.state.characterTurn.vector.y=t.y,this.state.characterTurn.actions.walk.state="in-use"}if(this.state.characterTurn.position.x===this.state.characterDestination.x&&this.state.characterTurn.position.y===this.state.characterDestination.y&&this.state.characterTurn.position.x!==this.state.characterTurn.originalPosition.x&&this.state.characterTurn.position.y!==this.state.characterTurn.originalPosition.y){if(this.state.characterTurn.actions.walk.state="not-in-use","complete"===this.state.characterTurn.actions.hit.state){this.executeAction({skill:this.state.selectedSkill,targets:[this.state.selectedTargets[0]]}),this.state.characterTurn.actions.hit.state="not-in-use",this.state.characterTurn.actions.hit.durationMs=0,this.state.selectedTargets.splice(0,1),this.state.characterDestination=this.state.characterTurn.originalPosition;let t=new l(this.state.characterDestination.x-this.state.characterTurn.position.x,this.state.characterDestination.y-this.state.characterTurn.position.y);t.x/=1.5,t.y/=1.5,this.state.characterTurn.vector.x=t.x,this.state.characterTurn.vector.y=t.y,this.state.characterTurn.actions.walk.state="in-use"}else this.state.characterTurn.actions.hit.state="in-use"}this.state.characterTurn.position.x===this.state.characterDestination.x&&this.state.characterTurn.position.y===this.state.characterDestination.y&&this.state.characterDestination.x===this.state.characterTurn.originalPosition.x&&this.state.characterDestination.y===this.state.characterTurn.originalPosition.y&&(this.state.characterTurn.actions.walk.state,this.state.selectedTargets[0]?this.state.characterDestination={x:this.state.selectedTargets[0].position.x+e(this.state.characterTurn),y:this.state.selectedTargets[0].position.y}:(this.state.characterTurn.atkBar=0,this.state={name:"PROGRESS_ATB"}));break}case"CALCULATE_FOE_ACTION":{let t=this.state.characterTurn.role.skills[r(0,this.state.characterTurn.role.skills.length-1)],e=t.numberOfTargets,i=this.battle.active.players.filter(t=>t.stats.hp>0),s=[];if(0===(s=i.length<=e?i:h(i).slice(0,e)).length)throw Error("Couldn't find any valid targets during foes turn!");this.state={name:"ANIMATING_ACTION",characterTurn:this.state.characterTurn,selectedSkill:t,selectedTargets:s,characterDestination:null}}}if(tR.some(t=>this.game.input.has(t)))for(let t of this.game.input)switch(this.state.name){case"PLAYER_SELECT_SKILL":switch(t){case"up":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,i=t.find(t=>t.some(t=>t===e));if(!i)throw Error("#columnWithFocusedSkill is undefined");let s=i.indexOf(e),a=i.at(s-1);a&&(this.state.focusedSkill=a);break}case"down":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,i=t.find(t=>t.some(t=>t===e));if(!i)throw Error("#columnWithFocusedSkill is undefined");let s=i.indexOf(e),a=i.at(s-2+1);a&&(this.state.focusedSkill=a);break}case"left":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,i=t.find(t=>t.some(t=>t===e));if(!i)throw Error("#columnWithFocusedSkill is undefined");let s=t.findIndex(t=>t.some(t=>t===e)),a=i.indexOf(e),o=t.at(s-1)?.at(a)||t.at(s-2)?.at(a);o&&(this.state.focusedSkill=o);break}case"right":{let t=this.mapToSkillSet(this.state.characterTurn.role.skills),e=this.state.focusedSkill,i=t.find(t=>t.some(t=>t===e));if(!i)throw Error("#columnWithFocusedSkill is undefined");let s=t.findIndex(t=>t.some(t=>t===e)),a=i.indexOf(e),o=t.at(s-t.length+1)?.at(a)||t.at(s-t.length+2)?.at(a);o&&(this.state.focusedSkill=o);break}case"enter":this.state={name:"PLAYER_SELECT_TARGET",characterTurn:this.state.characterTurn,selectedSkill:this.state.focusedSkill,selectedTargets:[],focusedTarget:this.battle.active.foes[0]}}break;case"PLAYER_SELECT_TARGET":{let e=[...this.battle.active.players,...this.battle.active.foes],i=e.indexOf(this.state.focusedTarget),[s]=e.splice(i,1);if(!s)throw Error("#currentlySelectedTarget is undefined!");let a=e.map(t=>({target:t,vectorTo:new l(t.position.x-s.position.x,t.position.y-s.position.y)}));switch(t){case"up":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.y)>Math.abs(e.x)}).filter(t=>t.vectorTo.y<0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"down":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.y)>Math.abs(e.x)}).filter(t=>t.vectorTo.y>0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"left":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.x)>Math.abs(e.y)}).filter(t=>t.vectorTo.x<0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"right":{let t=a.filter(t=>{let e=t.vectorTo.norm();return Math.abs(e.x)>Math.abs(e.y)}).filter(t=>t.vectorTo.x>0);if(0===t.length)break;let[e]=t.sort((t,e)=>t.vectorTo.magnitude()-e.vectorTo.magnitude());this.state.focusedTarget=e.target;break}case"enter":this.state.selectedTargets.push(this.state.focusedTarget),this.state.selectedTargets.length>=this.state.selectedSkill.numberOfTargets&&(this.state={name:"ANIMATING_ACTION",characterTurn:this.state.characterTurn,characterDestination:null,selectedSkill:this.state.selectedSkill,selectedTargets:this.state.selectedTargets})}}}}}updateAnimations(t){this.animations=this.animations.map(e=>({...e,timePassedMs:e.timePassedMs+1e3*t}));let e=this.animations.reduce((t,e)=>e.timePassedMs>=e.durationMs?{...t,finished:[...t.finished,e]}:{...t,inProgress:[...t.inProgress,e]},{inProgress:[],finished:[]});return this.animations=e.inProgress,{deleted:e.finished}}mapToSkillSet(t){let e=Array(t.length%2==0?t.length:t.length+t.length%2).fill(null);for(let i=0;i<e.length;i++)t[i]&&(e[i]=t[i]);let i=e.length/2,s=[];for(let t=0;t<i;t++)s.push(e.slice(2*t,2*t+2));return s}executeAction({skill:t,targets:e}){e.forEach(e=>{e.effects.push(t.generateSkillEffect({}))}),e.forEach(t=>{t.effects.filter(t=>"damage"===t.type).forEach(e=>{t.stats.hp-=e.points}),t.effects=t.effects.filter(t=>"damage"!==t.type)})}draw(t,e){if(this.battle.active){if(t.clearRect(0,0,this.game.gameWidth,this.game.gameHeight),!this.animations.some(t=>"commence-battle"===t.type))for(let i of(t.imageSmoothingEnabled=!1,this.battle.active.drawBackground({ctx:t,game:this.game}),[...this.battle.active.foes,...this.battle.active.players])){let s="PLAYER_SELECT_TARGET"===this.state.name&&this.state.selectedTargets.some(t=>t===i),a="PLAYER_SELECT_TARGET"===this.state.name&&this.state.focusedTarget===i;i.draw({ctx:t},e,s,a)}for(let i of this.animations){let s=Math.min(i.timePassedMs/i.durationMs,1);if("commence-battle"===i.type){let i=this.game.gameWidth*s-this.game.gameWidth;t.imageSmoothingEnabled=!1,this.battle.active.drawBackground({ctx:t,game:this.game,offsetX:-i,offsetY:0});let a=this.game.gameWidth-this.game.gameWidth*s;for(let i of[...this.battle.active.foes,...this.battle.active.players])i.draw({ctx:t,offsetX:-a,offsetY:0},e)}}"PLAYER_SELECT_SKILL"===this.state.name&&this.drawSkillBar(t,this.state)}}drawSkillBar(t,e){let i=this.mapToSkillSet(e.characterTurn.role.skills);for(let e=0;e<i.length;e++)for(let s=0;s<2;s++){let a=this.game.gameWidth/i.length;t.save(),t.fillStyle="lightgray",t.lineWidth=5,t.strokeStyle="black",t.fillRect(a*e,50*s,a,50),t.strokeRect(a*e+2.5,50*s+2.5,a-5,45),t.restore();let o=i[e][s];o&&(t.save(),t.font="30px serif",t.textAlign="center",t.fillStyle="black",t.fillText(o.name,a*e+a/2,50*s+40),t.restore())}for(let s=0;s<i.length;s++)for(let a=0;a<2;a++){if(i[s][a]!==e.focusedSkill)continue;let o=this.game.gameWidth/i.length;t.save(),t.lineWidth=5,t.strokeStyle="red",t.strokeRect(o*s+2.5,50*a+2.5,o-5,45),t.restore()}}}class tI{position;size;vector;components;constructor(t,e,i=new l(0,0),s=[]){this.position=t,this.size=e,this.vector=i,this.components=s}distanceTo(t){return Math.sqrt(Math.pow(this.position.x-t.position.x,2)+Math.pow(this.position.y-t.position.y,2))}getComponent(t){for(let e of this.components)if(e instanceof t)return e;throw Error(`Failed to get component type ${t}. Please run hasComponent first!`)}addComponents(...t){for(let e of t)this.components.push(e)}hasComponent(t){for(let e of this.components)if(e instanceof t)return!0;return!1}removeComponent(t){this.components=this.components.filter(e=>e!==t)}calculateHitbox(){throw Error("#calculateHitbox not implemented yet")}draw(t,e){throw Error("#draw not implemented yet")}}var tL={};tL=new URL("blood_splatter_v1-Sheet.5ea6ebae.png",import.meta.url).toString();const tH=new Image;tH.src=t(tL);const tB={sprites:12,img:tH,width:46,height:35};class tP extends tI{direction;durationMs;progressMs=0;constructor(t,e,i,s={height:2.1*tB.height,width:2.1*tB.width}){super(t,s,new l(0,0)),this.direction=e,this.durationMs=i}calculateHitbox(){let t=this.position.x;return{x:t,y:this.position.y,width:this.size.width,height:this.size.height}}draw(t,e){t.save(),t.imageSmoothingEnabled=!1;let i=1;"left"===this.direction&&(i=-1),"right"===this.direction&&(i=1),t.scale(i,1);let s=Math.floor((this.progressMs>this.durationMs?this.progressMs%this.durationMs/this.durationMs:this.progressMs/this.durationMs)*tB.sprites);t.drawImage(tB.img,tB.width*s,0,tB.width,tB.height,i*this.position.x,this.position.y,this.size.width,this.size.height),t.restore(),this.progressMs+=1e3*e}}class tO{constructor(){}}class tF extends tO{collisionGroup;collidesWith;stationary;onCollision;restitution;collisionLeft=[];collisionRight=[];collisionTop=[];collisionBottom=[];constructor(t,e=[],i=!1,s=()=>{},a=0){super(),this.collisionGroup=t,this.collidesWith=e,this.stationary=i,this.onCollision=s,this.restitution=a}}class tU extends tO{countdown;constructor(t=0){super(),this.countdown=t}}class tj extends tO{points;hitPosition;hitDirection;triggerInMs;constructor(t,e,i,s=0){super(),this.points=t,this.hitPosition=e,this.hitDirection=i,this.triggerInMs=s}}var tW={};tW=new URL("gun_bullet_trail-Sheet.05730235.png",import.meta.url).toString();var tD={};tD=new URL("gun_bullet.bfef5470.png",import.meta.url).toString();const tY=new Image;tY.src=t(tD);const tq={img:tY,width:2,height:1},tG=new Image;tG.src=t(tW);const tN={sprites:3,img:tG,width:10,height:1};class tX extends tI{fallOfTimeMs;bulletTrailAnimation={durationMs:225,progressMs:0};constructor(t,e,i=3e3){super(t,{width:5*tq.width,height:5*tq.height},e,[new tF("playerAttack",["mob"],!0,(t,e,i)=>{let s=e.calculateHitbox(),a=t.calculateHitbox(),o=t.vector.x<=0?"left":"right",n="left"===o?{x:a.x,y:a.y}:{x:a.x+a.width,y:a.y},r="left"===o?{x:n.x-s.width,y:n.y}:{x:n.x+s.width,y:n.y};t.addComponents(new tU),e.addComponents(new tj(20,r,o));let h=new tP(r,o,500);h.addComponents(new tU(500)),i.marioSystem.entities.push(h)})]),this.fallOfTimeMs=i}calculateHitbox(){let t=this.position.x;return{x:t,y:this.position.y,width:this.size.width,height:this.size.height}}draw(t,e){t.save();let i=this.vector.x>0?-1:1;t.scale(i,1);let s=Math.floor((this.bulletTrailAnimation.progressMs>this.bulletTrailAnimation.durationMs?this.bulletTrailAnimation.progressMs%this.bulletTrailAnimation.durationMs/this.bulletTrailAnimation.durationMs:this.bulletTrailAnimation.progressMs/this.bulletTrailAnimation.durationMs)*tN.sprites);t.drawImage(tN.img,tN.width*s,0,tN.width,tN.height,i*(this.position.x+(this.vector.x>0?-this.size.width:this.size.width)),this.position.y,this.size.width*(tN.width/tq.width),this.size.height),t.drawImage(tq.img,0,0,tq.width,tq.height,i*this.position.x,this.position.y,this.size.width,this.size.height),t.restore(),this.bulletTrailAnimation.progressMs+=1e3*e,this.fallOfTimeMs-=1e3*e}}class tK extends tO{pull;constructor(t){super(),this.pull=t}}class t$ extends tO{strength;dexterity;intelligence;hp;mana;speed;maxHp;maxMana;constructor(t){super(),this.strength=t.strength,this.dexterity=t.dexterity,this.intelligence=t.intelligence,this.hp=t.hp,this.maxHp=t.hp,this.mana=t.mana,this.maxMana=t.mana,this.speed=t.speed}}class tV extends tI{direction="left";actions={walk:{state:"not-in-use",durationMs:0,completeMs:1125},sprint:{state:"not-in-use",durationMs:0,completeMs:1e3},draw:{state:"not-in-use",durationMs:0,completeMs:750},stowe:{state:"not-in-use",durationMs:0,completeMs:750},jump:{state:"not-in-use",durationMs:0,completeMs:600},leap:{state:"not-in-use",durationMs:0,completeMs:1e3},ascend:{state:"not-in-use",durationMs:0,completeMs:1e3},descend:{state:"not-in-use",durationMs:0,completeMs:1e3},crouch:{state:"not-in-use",durationMs:0,completeMs:1e3},shoot:{state:"not-in-use",durationMs:0,completeMs:1e3},buttAttack:{state:"not-in-use",durationMs:0,completeMs:420}};weapon={state:"drawn"};constructor(t,e={height:140,width:100}){super(t,e,new l(0,0),[new tK(1e3),new tF("player",["wall"]),new t$({strength:1,dexterity:1,intelligence:1,speed:1,hp:100,mana:100})])}calculateHitbox(){let t=this.position.x-this.size.width/2*.5;return{x:t,y:this.position.y-this.size.height,width:this.size.width-.5*this.size.width,height:this.size.height}}decideBodySprite(){switch(!0){case"in-use"===this.actions.buttAttack.state:return{presets:tu,action:this.actions.buttAttack};case"complete"===this.actions.buttAttack.state:return{presets:tg,action:null};case"in-use"===this.actions.jump.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.jump.state&&"not-drawn"===this.weapon.state:return{presets:G,action:this.actions.jump};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:$,action:this.actions.leap};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:J,action:this.actions.leap};case"in-use"===this.actions.ascend.state:return{presets:J,action:this.actions.ascend};case"in-use"===this.actions.descend.state:return{presets:ts,action:this.actions.descend};case"in-use"===this.actions.stowe.state:return{presets:Y,action:this.actions.stowe};case"in-use"===this.actions.draw.state:return{presets:W,action:this.actions.draw};case"in-use"===this.actions.walk.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.walk.state&&"not-drawn"===this.weapon.state:return{presets:L,action:this.actions.walk};case"in-use"===this.actions.sprint.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.sprint.state&&"not-drawn"===this.weapon.state:return{presets:O,action:this.actions.sprint};case"drawn"===this.weapon.state:return{presets:tl,action:null};case"not-drawn"===this.weapon.state:default:return{presets:tr,action:null}}}decideLegsSprite(){if("in-use"===this.actions.buttAttack.state||"complete"===this.actions.buttAttack.state)return null;switch(!0){case"in-use"===this.actions.jump.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.jump.state&&"not-drawn"===this.weapon.state:return{presets:X,action:this.actions.jump};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:Q,action:this.actions.leap};case"in-use"===this.actions.leap.state&&"not-drawn"===this.weapon.state:return{presets:te,action:this.actions.leap};case"in-use"===this.actions.ascend.state:return{presets:te,action:this.actions.ascend};case"in-use"===this.actions.descend.state:return{presets:to,action:this.actions.descend};case"in-use"===this.actions.walk.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.walk.state&&"not-drawn"===this.weapon.state:return{presets:B,action:this.actions.walk};case"in-use"===this.actions.sprint.state&&"drawn"===this.weapon.state:case"in-use"===this.actions.sprint.state&&"not-drawn"===this.weapon.state:return{presets:U,action:this.actions.sprint};default:return{presets:tp,action:null}}}draw(t){t.save();let e=this.calculateHitbox();t.fillStyle="grey",t.fillRect(e.x,e.y-20,e.width,10),t.fillStyle="red",t.fillRect(e.x,e.y-20,e.width*(this.getComponent(t$).hp/this.getComponent(t$).maxHp),10),t.fillStyle="grey",t.fillRect(e.x,e.y-10,e.width,10),t.fillStyle="blue",t.fillRect(e.x,e.y-10,e.width*(this.getComponent(t$).mana/this.getComponent(t$).maxMana),10),t.lineWidth=2,t.strokeStyle="yellow",t.strokeRect(e.x,e.y-20,e.width,10),t.strokeStyle="yellow",t.strokeRect(e.x,e.y-10,e.width,10),t.imageSmoothingEnabled=!1;let i=1;"right"===this.direction&&(i=-1),"left"===this.direction&&(i=1),t.scale(i,1);let s=this.decideBodySprite(),a=Math.floor((null===s.action?0:s.action.durationMs>s.action.completeMs?s.action.durationMs%s.action.completeMs/s.action.completeMs:s.action.durationMs/s.action.completeMs)*s.presets.sprites);t.drawImage(s.presets.img,20*a,0,20,28,i*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height);let o=this.decideLegsSprite();if(o){let e=Math.floor((null===o.action?0:o.action.durationMs>o.action.completeMs?o.action.durationMs%o.action.completeMs/o.action.completeMs:o.action.durationMs/o.action.completeMs)*o.presets.sprites);t.drawImage(o.presets.img,20*e,0,20,28,i*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}t.restore()}}var tQ={};tQ=new URL("wall_texture_1.83063d22.png",import.meta.url).toString();const tZ=new Image;tZ.src=t(tQ);const tJ={img:tZ,width:20,height:20};class t0 extends tI{constructor(t,e){super({x:t.x-.5,y:t.y-.5},{width:e.width+1,height:e.height+1}),this.addComponents(new tF("wall",[],!0))}calculateHitbox(){let t=this.position.x;return{x:t,y:this.position.y,width:this.size.width,height:this.size.height}}draw(t){t.save(),t.imageSmoothingEnabled=!1;let e=t.createPattern(tJ.img,"repeat");null!==e&&(t.fillStyle=e),t.drawImage(tJ.img,0,0,tJ.width,tJ.height,this.position.x,this.position.y,this.size.width,this.size.height),t.restore()}}var t1={};t1=new URL("stale_zombie_v1_full-Sheet.38e83773.png",import.meta.url).toString();var t2={};t2=new URL("walk_zombie_v1_legs-Sheet.578f3c1b.png",import.meta.url).toString();var t3={};t3=new URL("walk_zombie_v1_body-Sheet.545edeb0.png",import.meta.url).toString();var t5={};t5=new URL("dying_zombie_v1_full_body-Sheet.388c852b.png",import.meta.url).toString();var t4={};t4=new URL("dying_zombie_v1_stale_full_body.d9ccbe80.png",import.meta.url).toString();var t8={};t8=new URL("stale_crawler_zombie_full-Sheet.59a6944b.png",import.meta.url).toString();var t6={};t6=new URL("sprint_crawler_zombie_full-Sheet.43a4c6e8.png",import.meta.url).toString();const t7=new Image;t7.src=t(t1);const t9={sprites:5,img:t7},et=new Image;et.src=t(t2);const ee={sprites:6,img:et},ei=new Image;ei.src=t(t3);const es={sprites:6,img:ei},ea=new Image;ea.src=t(t5);const eo={sprites:5,img:ea},en=new Image;en.src=t(t4);const er={sprites:1,img:en},eh=new Image;eh.src=t(t8);const el={sprites:8,img:eh},ec=new Image;ec.src=t(t6);const ep={sprites:9,img:ec};class ed extends tI{direction="right";actions={stale:{state:"in-use",durationMs:0,completeMs:2250},walk:{state:"not-in-use",durationMs:0,completeMs:1e3},die:{state:"not-in-use",durationMs:0,completeMs:1e3}};constructor(t,e={height:140,width:140}){super(t,e,new l(0,0),[new tK(1e3),new tF("mob",["wall"]),new t$({strength:1,dexterity:1,intelligence:1,speed:1,hp:100,mana:100})])}calculateHitbox(){let t=this.position.x-this.size.width/2*.2;return{x:t,y:this.position.y-this.size.height,width:this.size.width-.8*this.size.width,height:this.size.height}}decideBodySprite(){switch(!0){case"in-use"===this.actions.die.state:return{presets:eo,action:this.actions.die};case"complete"===this.actions.die.state:return{presets:er,action:null};case"in-use"===this.actions.walk.state:return{presets:es,action:this.actions.walk};default:return{presets:t9,action:this.actions.stale}}}decideLegsSprite(){return"in-use"===this.actions.die.state||"complete"===this.actions.die.state?null:!0==("in-use"===this.actions.walk.state)?{presets:ee,action:this.actions.walk}:null}draw(t){t.save(),this.calculateHitbox(),t.imageSmoothingEnabled=!1;let e=1;"left"===this.direction&&(e=-1),"right"===this.direction&&(e=1),t.scale(e,1);let i=this.decideBodySprite(),s=Math.floor((null===i.action?0:i.action.durationMs>i.action.completeMs?i.action.durationMs%i.action.completeMs/i.action.completeMs:i.action.durationMs/i.action.completeMs)*i.presets.sprites);t.drawImage(i.presets.img,30*s,0,30,30,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height);let a=this.decideLegsSprite();if(a){let i=Math.floor((null===a.action?0:a.action.durationMs>a.action.completeMs?a.action.durationMs%a.action.completeMs/a.action.completeMs:a.action.durationMs/a.action.completeMs)*a.presets.sprites);t.drawImage(a.presets.img,30*i,0,30,30,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}t.restore()}}class eu{appliesTo(t){return!1}update(t,e,i){throw Error("not implemented")}}class em extends eu{constructor(){super()}appliesTo(t){return t instanceof ed}update(t,e,i){let s=t.marioSystem.player;for(let t of e){if(!(t instanceof ed))throw Error("#appliesTo not called before update");if(this.updateActionTimers(t,i),t.hasComponent(tF)&&0!==t.getComponent(tF).collisionBottom.length&&t.vector.y>1e3&&(t.vector.y=0),t.hasComponent(t$)&&t.getComponent(t$).hp<=0&&"not-in-use"===t.actions.die.state&&(t.hasComponent(tF)&&(t.getComponent(tF).collisionGroup="cadaver"),t.actions.die.state="in-use",t.vector.x=0),!s||t.hasComponent(t$)&&t.getComponent(t$).hp<=0)continue;let e=[s].map(e=>({distance:t.distanceTo(e),player:e})).sort((t,e)=>t.distance-e.distance)[0];e.distance<=500?(e.player.position.x<t.position.x&&(t.actions.walk.state="in-use",t.direction="left",t.vector.x-500*i<=-100?t.vector.x=-100:t.vector.x-=500*i),e.player.position.x>t.position.x&&(t.actions.walk.state="in-use",t.direction="right",t.vector.x+500*i>=100?t.vector.x=100:t.vector.x+=500*i)):(t.actions.walk.state="not-in-use",t.actions.walk.durationMs=0,t.vector.x=0)}}updateActionTimers(t,e){"in-use"===t.actions.walk.state&&(t.actions.walk.durationMs+=1e3*e),"in-use"===t.actions.stale.state&&(t.actions.stale.durationMs+=1e3*e),"in-use"===t.actions.die.state&&(t.actions.die.durationMs+=1e3*e),t.actions.die.durationMs>=t.actions.die.completeMs&&(t.actions.die.state="complete")}}class eg extends tI{direction="right";actions={stale:{state:"in-use",durationMs:0,completeMs:2e3},walk:{state:"not-in-use",durationMs:0,completeMs:750},jumpAttack:{state:"not-in-use",durationMs:0,completeMs:2e3},die:{state:"not-in-use",durationMs:0,completeMs:1e3}};constructor(t,e={height:108,width:248}){super(t,e,new l(0,0),[new tK(1e3),new tF("mob",["wall"]),new t$({strength:1,dexterity:1,intelligence:1,speed:1,hp:100,mana:100})])}calculateHitbox(){let t=this.position.x-this.size.width/2*.2;return{x:t,y:this.position.y-this.size.height,width:this.size.width-.8*this.size.width,height:this.size.height}}decideBodySprite(){switch(!0){case"in-use"===this.actions.die.state:case"complete"===this.actions.die.state:return{presets:el,action:null};case"in-use"===this.actions.walk.state:return{presets:ep,action:this.actions.walk};default:return{presets:el,action:this.actions.stale}}}decideLegsSprite(){return"in-use"===this.actions.die.state||this.actions.die.state,null}draw(t){t.save(),this.calculateHitbox(),t.imageSmoothingEnabled=!1;let e=1;"left"===this.direction&&(e=-1),"right"===this.direction&&(e=1),t.scale(e,1);let i=this.decideBodySprite(),s=Math.floor((null===i.action?0:i.action.durationMs>i.action.completeMs?i.action.durationMs%i.action.completeMs/i.action.completeMs:i.action.durationMs/i.action.completeMs)*i.presets.sprites);t.drawImage(i.presets.img,62*s,0,62,27,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height);let a=this.decideLegsSprite();if(a){let i=Math.floor((null===a.action?0:a.action.durationMs>a.action.completeMs?a.action.durationMs%a.action.completeMs/a.action.completeMs:a.action.durationMs/a.action.completeMs)*a.presets.sprites);t.drawImage(a.presets.img,62*i,0,62,27,e*this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height)}t.restore()}}class ew extends eu{constructor(){super()}appliesTo(t){return t instanceof eg}update(t,e,i){let s=t.marioSystem.player;for(let t of e){if(!(t instanceof eg))throw Error("#appliesTo not called before update");if(this.updateActionTimers(t,i),t.hasComponent(tF)&&0!==t.getComponent(tF).collisionBottom.length&&t.vector.y>1e3&&(t.vector.y=0),t.hasComponent(tF)&&t.getComponent(tF).collisionBottom.some(t=>t.initialCollision)&&"in-use"===t.actions.jumpAttack.state&&(t.actions.jumpAttack.state="not-in-use",t.vector.x=0),t.hasComponent(t$)&&t.getComponent(t$).hp<=0&&"not-in-use"===t.actions.die.state&&(t.hasComponent(tF)&&(t.getComponent(tF).collisionGroup="cadaver"),t.actions.die.state="in-use",t.vector.x=0),"in-use"===t.actions.jumpAttack.state||!s||t.hasComponent(t$)&&t.getComponent(t$).hp<=0)continue;let e=[s].map(e=>({distance:t.distanceTo(e),player:e})).sort((t,e)=>t.distance-e.distance)[0];e.distance<=950?(e.player.position.x<t.position.x&&(t.direction="left",e.distance<=200&&t.vector.x<=-350?(t.actions.jumpAttack.state="in-use",t.vector.x=-1e3,t.vector.y=-250):(t.actions.walk.state="in-use",t.vector.x-800*i<=-700?t.vector.x=-700:t.vector.x-=800*i)),e.player.position.x>t.position.x&&(t.direction="right",e.distance<=200&&t.vector.x>=350?(t.actions.jumpAttack.state="in-use",t.vector.x=1e3,t.vector.y=-250):(t.actions.walk.state="in-use",t.vector.x+800*i>=700?t.vector.x=700:t.vector.x+=800*i))):(t.actions.walk.state="not-in-use",t.actions.walk.durationMs=0,t.vector.x=0)}}updateActionTimers(t,e){"in-use"===t.actions.stale.state&&(t.actions.stale.durationMs+=1e3*e),"in-use"===t.actions.walk.state&&(t.actions.walk.durationMs+=1e3*e),"in-use"===t.actions.die.state&&(t.actions.die.durationMs+=1e3*e),"in-use"===t.actions.jumpAttack.state&&(t.actions.jumpAttack.durationMs+=1e3*e),t.actions.die.durationMs>=t.actions.die.completeMs&&(t.actions.die.state="complete")}}class ef extends eu{constructor(){super()}appliesTo(t){return t.hasComponent(tF)}update(t,e,i){let s=e.map(t=>({entity:t,collisionBottom:[],collisionLeft:[],collisionRight:[],collisionTop:[]}));for(let t of e)for(let i of e){if(!t.hasComponent(tF)||!i.hasComponent(tF))throw Error("#appliesTo not called before update");if(t===i||!i.getComponent(tF).collidesWith.some(e=>e===t.getComponent(tF).collisionGroup))continue;let e=t.calculateHitbox(),a=i.calculateHitbox(),o=e.x+.5*e.width,n=e.y+.5*e.height,r=a.x+.5*a.width,h=a.y+.5*a.height,l=r-o,c=h-n,p=(a.width+e.width)*.5,d=(a.height+e.height)*.5;if(Math.abs(l)>p||Math.abs(c)>d)continue;let u=t.getComponent(tF),m=i.getComponent(tF);if(-1===s.findIndex(e=>e.entity===t)||-1===s.findIndex(t=>t.entity===i))throw Error("Collision data not found");if(Math.abs(l/e.width)>Math.abs(c/e.height)){if(l<0){let o=-1===u.collisionLeft.findIndex(t=>t.entity===i),n=s.findIndex(e=>e.entity===t);s[n].collisionLeft.push({entity:i,initialCollision:o});let r=-1===m.collisionRight.findIndex(e=>e.entity===t),h=s.findIndex(t=>t.entity===i);if(s[h].collisionRight.push({entity:t,initialCollision:r}),i.getComponent(tF).stationary)continue;let l=e.x-a.x-a.width;i.position.x+=l}else{let o=-1===u.collisionRight.findIndex(t=>t.entity===i),n=s.findIndex(e=>e.entity===t);s[n].collisionRight.push({entity:i,initialCollision:o});let r=-1===m.collisionLeft.findIndex(e=>e.entity===t),h=s.findIndex(t=>t.entity===i);if(s[h].collisionLeft.push({entity:t,initialCollision:r}),i.getComponent(tF).stationary)continue;let l=e.x-a.x+e.width;i.position.x+=l}}else if(c<0){let o=-1===u.collisionTop.findIndex(t=>t.entity===i),n=s.findIndex(e=>e.entity===t);s[n].collisionTop.push({entity:i,initialCollision:o});let r=-1===m.collisionBottom.findIndex(e=>e.entity===t),h=s.findIndex(t=>t.entity===i);if(s[h].collisionBottom.push({entity:t,initialCollision:r}),i.getComponent(tF).stationary)continue;let l=e.y-a.height-a.y;i.position.y+=l}else{let o=-1===u.collisionBottom.findIndex(t=>t.entity===i),n=s.findIndex(e=>e.entity===t);s[n].collisionBottom.push({entity:i,initialCollision:o});let r=-1===m.collisionTop.findIndex(e=>e.entity===t),h=s.findIndex(t=>t.entity===i);if(s[h].collisionTop.push({entity:t,initialCollision:r}),i.getComponent(tF).stationary)continue;let l=e.y+e.height-a.y;i.position.y+=l}}for(let t of e){let e=s.findIndex(e=>e.entity===t);if(-1===e)throw Error("Collision data not found");let i=s[e],a=t.getComponent(tF);a.collisionBottom=i.collisionBottom,a.collisionTop=i.collisionTop,a.collisionLeft=i.collisionLeft,a.collisionRight=i.collisionRight}for(let i of e){let e=i.getComponent(tF);[...e.collisionBottom,...e.collisionTop,...e.collisionLeft,...e.collisionRight].filter(t=>t.initialCollision).forEach(s=>e.onCollision(i,s.entity,t))}}}class ey extends eu{constructor(){super()}appliesTo(t){return t.hasComponent(tU)}update(t,e,i){for(let s of e){if(!s.hasComponent(tU))throw Error("#appliesTo not called before update");let e=s.getComponent(tU);e.countdown-=1e3*i,e.countdown<=0&&t.marioSystem.entities.splice(t.marioSystem.entities.indexOf(s),1)}}}class ex extends eu{constructor(){super()}appliesTo(t){return t.hasComponent(tK)}update(t,e,i){for(let t of e){let e=t.getComponent(tK).pull;t.vector.y+=e*i}}}class eS extends eu{constructor(){super()}appliesTo(t){return!0}update(t,e,i){for(let t of e){let e=t.vector;t.position.x+=e.x*i,t.position.y+=e.y*i}}}class eM{input=new Set;constructor(){document.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":return this.input.add("up");case"ArrowLeft":return this.input.add("left");case"ArrowDown":return this.input.add("down");case"ArrowRight":return this.input.add("right");case"s":return this.input.add("S");case"f":return this.input.add("F")}}),document.addEventListener("keyup",t=>{switch(t.key){case"ArrowUp":return this.input.delete("up");case"ArrowLeft":return this.input.delete("left");case"ArrowDown":return this.input.delete("down");case"ArrowRight":return this.input.delete("right");case"s":return this.input.delete("S");case"f":return this.input.delete("F")}})}getActions(t,e){return this.determineActions(this.input,t,e)}determineActions(t,e,i){let s=new Set;for(let i of t)switch(i){case"left":["jump","leap"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&s.add("sprint-left"),"drawn"===e.weapon.state&&s.add("walk-left"),s.delete("walk-right"),s.delete("sprint-right"));break;case"right":["jump","leap"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&s.add("sprint-right"),"drawn"===e.weapon.state&&s.add("walk-right"),s.delete("walk-left"),s.delete("sprint-left"));break;case"down":["jump","buttAttack","leap","stowe","draw","shoot"].every(t=>"not-in-use"===e.actions[t].state)&&"drawn"===e.weapon.state&&s.add("butt-attack");break;case"up":["jump","leap","ascend","descend","stowe","draw","shoot"].every(t=>"not-in-use"===e.actions[t].state)&&("not-drawn"===e.weapon.state&&s.add("draw-weapon"),"drawn"===e.weapon.state&&s.add("stowe-weapon"),s.delete("shoot"),s.delete("jump"),s.delete("leap"));break;case"S":["jump","leap","ascend","descend","draw","shoot"].every(t=>"not-in-use"===e.actions[t].state)&&(("not-drawn"===e.weapon.state||"in-use"===e.actions.stowe.state)&&s.add("leap"),"drawn"===e.weapon.state&&s.add("jump"),s.delete("shoot"),s.delete("draw-weapon"),s.delete("stowe-weapon"));break;case"F":["jump","ascend","descend","stowe","draw","leap"].every(t=>"not-in-use"===e.actions[t].state)&&"drawn"===e.weapon.state&&(s.delete("jump"),s.add("shoot"))}return s.forEach(t=>{i.has(t)&&s.delete(t)}),s}}var eb={};eb=new URL("ground_crumble_effect_v2-Sheet.ce4cbca3.png",import.meta.url).toString();const ek=new Image;ek.src=t(eb);const ev={sprites:6,img:ek,width:50,height:12};class eT extends tI{durationMs;progressMs=0;constructor(t,e=500,i={height:50,width:250}){super(t,i,new l(0,0),[new tU(e),new tF("playerAttack",["mob"],!0,(t,e)=>{let i=e.calculateHitbox(),s=t.calculateHitbox(),a="left";e.vector.y=-200,s.x+s.width/2<i.x+i.width/2&&(e.vector.x=500,a="right"),s.x+s.width/2>i.x+i.width/2&&(e.vector.x=-500,a="left"),e.addComponents(new tj(20,{x:e.position.x,y:e.position.y},a))})]),this.durationMs=e}calculateHitbox(){let t=this.position.x-this.size.width/2;return{x:t,y:this.position.y-this.size.height,width:this.size.width,height:this.size.height}}draw(t,e){t.save(),t.imageSmoothingEnabled=!1;let i=Math.floor((this.progressMs>this.durationMs?this.progressMs%this.durationMs/this.durationMs:this.progressMs/this.durationMs)*ev.sprites);t.drawImage(ev.img,ev.width*i,0,ev.width,ev.height,this.position.x-this.size.width/2,this.position.y-this.size.height,this.size.width,this.size.height),t.restore(),this.progressMs+=1e3*e}}class e_ extends eu{inputHandler=new eM;actionCooldowns=new Map;constructor(){super()}appliesTo(t){return t instanceof tV}update(t,e,i){for(let s of e){if(!(s instanceof tV))throw Error("#update called with non Player instance");this.updateActionTimers(s,i),this.updateActionCooldowns(i);let e=this.inputHandler.getActions(s,this.actionCooldowns),a=["walk-left","walk-right"],o=["sprint-left","sprint-right"];if(![...a,...o].some(t=>e.has(t))&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.vector.x=0),a.some(t=>e.has(t))||(s.actions.walk.state="not-in-use",s.actions.walk.durationMs=0),o.some(t=>e.has(t))||(s.actions.sprint.state="not-in-use",s.actions.sprint.durationMs=0),e.has("crouch")||(s.actions.crouch.state="not-in-use",s.actions.crouch.durationMs=0),s.hasComponent(tF)&&s.getComponent(tF).collisionBottom.every(t=>!0===t.initialCollision)&&this.actionCooldowns.set("leap",500),s.hasComponent(tF)&&0===s.getComponent(tF).collisionBottom.length&&(0!==s.getComponent(tF).collisionLeft.length&&s.getComponent(tF).collisionLeft.every(t=>!0===t.initialCollision)&&(s.vector.x=200),0!==s.getComponent(tF).collisionRight.length&&s.getComponent(tF).collisionRight.every(t=>!0===t.initialCollision)&&(s.vector.x=-200)),s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length){if("complete"===s.actions.buttAttack.state){let e=new eT({x:s.position.x,y:s.position.y});t.marioSystem.entities.push(e)}s.actions.ascend.state="not-in-use",s.actions.ascend.durationMs=0,s.actions.descend.state="not-in-use",s.actions.descend.durationMs=0,s.actions.leap.state="not-in-use",s.actions.leap.durationMs=0,s.actions.buttAttack.state="not-in-use",s.actions.buttAttack.durationMs=0,s.vector.y=0}if("complete"===s.actions.jump.state&&(s.vector.y=-600,s.actions.ascend.state="in-use","left"===s.direction&&(s.vector.x=-300),"right"===s.direction&&(s.vector.x=300)),"complete"===s.actions.draw.state&&(s.weapon.state="drawn"),s.vector.y>0&&(s.actions.ascend.state="not-in-use",s.actions.ascend.durationMs=0),s.hasComponent(tF)&&0===s.getComponent(tF).collisionBottom.length&&s.vector.y>0&&(s.actions.descend.state="in-use"),"in-use"===s.actions.buttAttack.state&&(s.vector.y=0,s.vector.x=0),"complete"===s.actions.buttAttack.state&&(s.vector.y=1400),e.has("shoot")){let e="right"===s.direction?1e3:-1e3,i="right"===s.direction?s.position.x+s.size.width/2:s.position.x-s.size.width/2;t.marioSystem.entities.push(new tX({x:i,y:s.position.y-s.size.height/2-s.size.height/50},new l(e,0))),this.actionCooldowns.set("shoot",100),s.actions.shoot.state="in-use"}e.has("walk-left")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.direction="left",s.vector.x=-250,s.actions.walk.state="in-use"),e.has("sprint-left")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.direction="left",s.vector.x=-500,s.actions.sprint.state="in-use"),e.has("walk-right")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.direction="right",s.vector.x=250,s.actions.walk.state="in-use"),e.has("sprint-right")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.direction="right",s.vector.x=500,s.actions.sprint.state="in-use"),e.has("jump")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.actions.jump.state="in-use"),e.has("leap")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.actions.leap.state="in-use","left"===s.direction&&(s.vector.x=-1e3),"right"===s.direction&&(s.vector.x=1e3),s.vector.y=-275),e.has("draw-weapon")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.actions.draw.state="in-use"),e.has("stowe-weapon")&&s.hasComponent(tF)&&0!==s.getComponent(tF).collisionBottom.length&&(s.actions.stowe.state="in-use",s.weapon.state="not-drawn"),e.has("butt-attack")&&s.hasComponent(tF)&&0===s.getComponent(tF).collisionBottom.length&&("in-use"===s.actions.descend.state||"in-use"===s.actions.ascend.state)&&(s.actions.buttAttack.state="in-use"),this.resetCompletedActions(s),this.resetCompletedCooldowns()}}updateActionTimers(t,e){"in-use"===t.actions.walk.state&&(t.actions.walk.durationMs+=1e3*e),"in-use"===t.actions.sprint.state&&(t.actions.sprint.durationMs+=1e3*e),"in-use"===t.actions.draw.state&&(t.actions.draw.durationMs+=1e3*e),"in-use"===t.actions.stowe.state&&(t.actions.stowe.durationMs+=1e3*e),"in-use"===t.actions.jump.state&&(t.actions.jump.durationMs+=1e3*e),"in-use"===t.actions.leap.state&&(t.actions.leap.durationMs+=1e3*e),"in-use"===t.actions.crouch.state&&(t.actions.crouch.durationMs+=1e3*e),"in-use"===t.actions.ascend.state&&(t.actions.ascend.durationMs+=1e3*e),"in-use"===t.actions.descend.state&&(t.actions.descend.durationMs+=1e3*e),"in-use"===t.actions.shoot.state&&(t.actions.shoot.durationMs+=1e3*e),"in-use"===t.actions.buttAttack.state&&(t.actions.buttAttack.durationMs+=1e3*e),t.actions.draw.durationMs>=t.actions.draw.completeMs&&(t.actions.draw.state="complete"),t.actions.stowe.durationMs>=t.actions.stowe.completeMs&&(t.actions.stowe.state="complete"),t.actions.jump.durationMs>=t.actions.jump.completeMs&&(t.actions.jump.state="complete"),t.actions.crouch.durationMs>=t.actions.crouch.completeMs&&(t.actions.crouch.state="complete"),t.actions.shoot.durationMs>=t.actions.shoot.completeMs&&(t.actions.shoot.state="complete"),t.actions.buttAttack.durationMs>=t.actions.buttAttack.completeMs&&(t.actions.buttAttack.state="complete")}updateActionCooldowns(t){this.actionCooldowns.forEach((e,i)=>{this.actionCooldowns.set(i,e-1e3*t)})}resetCompletedActions(t){"complete"===t.actions.walk.state&&(t.actions.walk.state="not-in-use",t.actions.walk.durationMs=0),"complete"===t.actions.sprint.state&&(t.actions.sprint.state="not-in-use",t.actions.sprint.durationMs=0),"complete"===t.actions.draw.state&&(t.actions.draw.state="not-in-use",t.actions.draw.durationMs=0),"complete"===t.actions.stowe.state&&(t.actions.stowe.state="not-in-use",t.actions.stowe.durationMs=0),"complete"===t.actions.jump.state&&(t.actions.jump.state="not-in-use",t.actions.jump.durationMs=0),"complete"===t.actions.leap.state&&(t.actions.leap.state="not-in-use",t.actions.leap.durationMs=0),"complete"===t.actions.crouch.state&&(t.actions.crouch.state="not-in-use",t.actions.crouch.durationMs=0),"complete"===t.actions.ascend.state&&(t.actions.ascend.state="not-in-use",t.actions.ascend.durationMs=0),"complete"===t.actions.descend.state&&(t.actions.descend.state="not-in-use",t.actions.descend.durationMs=0),"complete"===t.actions.shoot.state&&(t.actions.shoot.state="not-in-use",t.actions.shoot.durationMs=0)}resetCompletedCooldowns(){this.actionCooldowns.forEach((t,e)=>{t<=0&&this.actionCooldowns.delete(e)})}}class eA extends eu{constructor(){super()}appliesTo(t){return t.hasComponent(t$)&&t.hasComponent(tj)}update(t,e,i){for(let t of e){if(!t.hasComponent(t$)||!t.hasComponent(tj))throw Error("#appliesTo not called before update");let e=t.getComponent(t$),s=t.getComponent(tj);s.triggerInMs<=0&&(e.hp-=s.points,t.removeComponent(s)),e.hp,s.triggerInMs-=1e3*i}}}class eE{game;entities=[];player=null;gravitySystem=new ex;collisionSystem=new ef;deleteSystem=new ey;moveSystem=new eS;playerSystem=new e_;effectSystem=new eA;zombieV1Behavior=new em;crawlerBehavior=new ew;constructor(t){this.game=t}setupLevel(t){for(let e=0;e<t.entities.length;e++)for(let i=0;i<t.entities[e].length;i++){let s={width:t.width/t.entities[e].length,height:t.height/t.entities.length},a={x:s.width*i,y:s.height*e};0!==t.entities[e][i]&&(99===t.entities[e][i]&&(this.player=new tV({x:s.width*i,y:s.height*e})),98===t.entities[e][i]&&this.entities.push(new ed({x:s.width*i,y:s.height*e})),97===t.entities[e][i]&&this.entities.push(new eg({x:s.width*i,y:s.height*e})),1===t.entities[e][i]&&this.entities.push(new t0(a,s)))}}update(t){if(null!==this.player){for(let e of[this.deleteSystem,this.playerSystem,this.zombieV1Behavior,this.crawlerBehavior,this.gravitySystem,this.effectSystem,this.moveSystem,this.collisionSystem]){let i=[this.player,...this.entities].filter(e.appliesTo);e.update(this.game,i,t)}this.entities=this.entities.filter(t=>!(t instanceof tX)||t instanceof tX&&t.fallOfTimeMs>0)}}draw(t,e){if(null===this.player)return;let i=this.game.gameWidth/2,s=this.game.gameHeight/2;for(let a of[this.player,...this.entities])t.translate(-(this.player.position.x-i),-(this.player.position.y-s)),a.draw(t,e),t.resetTransform()}}o=class{gameWidth;gameHeight;mainCtx;mousePos;players=[{name:"mami",lvl:1,stats:{hp:60,maxHp:60,stamina:60,maxStamina:60,strength:1,intelligence:1,dodgeChance:.1,hitRate:.9,speed:2}},{name:"papi",lvl:1,stats:{hp:60,maxHp:60,stamina:60,maxStamina:60,strength:1,intelligence:1,dodgeChance:.1,hitRate:.9,speed:2}}];mapScreen=new tv(this);pauseScreen=new tC(this);battleSystem=new tz(this);marioSystem;input=new Set;state="MAP_SCREEN";paused=!1;visible=!0;constructor(t,e,i,s={x:t/2,y:e/2}){this.gameWidth=t,this.gameHeight=e,this.mainCtx=i,this.mousePos=s;let a=tT("gameScreen");this.marioSystem=new eE(this),window.addEventListener("resize",()=>{this.gameHeight=a.clientHeight,this.gameWidth=a.clientWidth}),window.addEventListener("visibilitychange",()=>{document.hidden?this.visible=!1:this.visible=!0}),a.addEventListener("click",()=>{this.input.add("leftClick")}),document.addEventListener("keydown",t=>{switch(t.key){case"Escape":this.input.add("esc"),this.paused=!this.paused;break;case"ArrowUp":this.input.add("up");break;case"ArrowLeft":this.input.add("left");break;case"ArrowDown":this.input.add("down");break;case"ArrowRight":this.input.add("right");break;case"s":this.input.add("s");break;case"Enter":this.input.add("enter")}}),document.addEventListener("keyup",t=>{switch(t.key){case"Escape":this.input.delete("esc");break;case"ArrowUp":this.input.delete("up");break;case"ArrowLeft":this.input.delete("left");break;case"ArrowDown":this.input.delete("down");break;case"ArrowRight":this.input.delete("right");break;case"Enter":this.input.delete("enter");break;case"s":this.input.delete("s")}}),a.addEventListener("mousemove",t=>{this.mousePos={x:t.offsetX,y:t.offsetY}}),this.start()}start(){}update(t){if(this.visible){if(this.paused){this.pauseScreen.show(),this.pauseScreen.update(),this.clearInput();return}switch(this.pauseScreen.hide(),this.state){case"MAP_SCREEN":this.mapScreen.update(t),this.clearInput();break;case"BATTLE_SCENE":this.battleSystem.update(t),this.clearInput();break;case"MARIO_GAME":this.marioSystem.update(t),this.clearInput();break;default:this.clearInput()}}}clearInput(){this.input.clear()}draw(t,e){switch(this.state){case"MAP_SCREEN":this.mapScreen.draw(t);break;case"BATTLE_SCENE":this.battleSystem.draw(t,e);break;case"MARIO_GAME":this.marioSystem.draw(t,e)}}};const eC=document.querySelector("#gameScreen"),eR=eC.getContext("2d");eR.imageSmoothingEnabled=!0,eR.imageSmoothingQuality="high";const ez=window.innerWidth,eI=window.innerHeight;eC.width=ez,eC.height=eI;const eL=new o(ez,eI,eR);let eH=0;requestAnimationFrame(function t(e){let i=(e-eH)/1e3;eH=e,eR.clearRect(0,0,ez,eI),eL.update(i),eL.draw(eR,i),requestAnimationFrame(t)});